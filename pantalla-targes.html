<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    
    <!-- jQuery -->
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/themes/cupertino/jquery-ui.css">
<!--
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
    <script src="wp-content/plugins/pcl/js/jquery-1.11.0.min.js"></script>
-->
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script> 
    <script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>



<!-- Bootstrap -->

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">



<style>
.centered{
    width: 100%;
    position: absolute;
    top: 10px;
    left: 0;
    right: 0;
    margin: auto;
}

.filtres{
    height: 30px;*/
    position: absolute;
    top: 10px!important;
    left: 0;
    right: 0;
    margin: auto;
}
</style>




<!--script incials-->
<script>
var numPag=1;
var Num_files=0;
var Num_columnes=0;
var dades=new Array();
var nTarFila=0;
var row_var=new Array();
var plantilles=new Array()


$(document).ready(function(){ 
   $("#btnTancar").click(function(){
		$('#imgtemp').remove();
    });   
});


var time = 20;
window.setInterval(test, 1000);
function test() {
	time -=1;
	if(time == 0) {
		$('#imgtemp').remove();
	}
}

function inicia(){
    google.script.run.withSuccessHandler(onVariables).recollidaVariables();    
    google.script.run.withSuccessHandler(onPlantilles).recollidaPlantilles();            
    //google.script.run.withSuccessHandler(onFiltres).creacioFiltres();        
}



//Visualitza les primeres fitxes
function onDades(dad) {
   dades=dad;
   creacioFiltres();
   novaPagina(0);
}


//Càrrega dels estils de la plantilla
function onPlantilles(plt) {
   plantilles=plt;
   estil="";   
   for (p=0; p<plantilles[0].length; p++){
      if (plantilles[0][p]=="<style>"){
        estil +=plantilles[1][p];
      }
   }
   //alert(estil);
   $('#estil').html(estil);   
}



//Càrrega dels filtres 
function creacioFiltres(){
  var f=0;
  var flt="";          
  for (c=0;c<dades[0].length; c++){
    if (dades[1][c]=="Desplegable"){
        var cmp="";
        flt +="<select name='"+dades[0][c]+"' id='sel_"+dades[0][c]+"' onChange='novaPagina(0)' style='width:100px; height: 30px; font-size: 14px; margin-right: 10px '>";        
        flt +="<option value='*'>"+dades[0][c]+"</option>";        
        for (var j = 0; j < dades.length-2 ; j++) {           
            var str=dades[2+j][c].replace(" ","_");
            if (cmp.indexOf(str)<0){
                flt +="<option value="+str+">"+dades[2+j][c]+"</option>";
                cmp +="#"+str;
            }
        }
        flt +="</select>";       
    } else if (dades[1][c]=="csvFiltre") {
        var cmp="";
        flt +="<select name='"+dades[0][c]+"' id='sel_"+dades[0][c]+"' onChange='novaPagina(0)' style='width:100px; height: 30px; font-size: 14px; margin-right: 10px '>";        
        flt +="<option value='*'>"+dades[0][c]+"</option>";        
        for (var j = 0; j < dades.length-2 ; j++) {           
            var str=dades[2+j][c].replace(" ","_");
            var xF=str.split(",");
            for (f=0;f<xF.length;f++){
                if (cmp.indexOf(xF[f])<0){
                    flt +="<option value="+xF[f]+">"+xF[f]+"</option>";
                    cmp +="#"+xF[f];
                }
            }
        }
        flt +="</select>";           
    
    }
  }
   $('#filtres').html(flt);
}



//Càrrega de les variables 
function onVariables(variables) {
   row_var=variables;
   for (v=0;v<row_var.length;v++){
       if (row_var[v][0]=="Num_files"){
          Num_files=row_var[v][1];
       }
       if (row_var[v][0]=="Num_columnes"){
          Num_columnes=row_var[v][1];
       }          
       if (row_var[v][0]=="Capçalera"){
          if (row_var[v][1]=='N'){
             $("#capçalera").hide();
          } else {
             $("#capçalera").show();          
          }
       }
   }
   //recollir les dades despres de les variables per garantir que està el nombre de files a mostrar
   google.script.run.withSuccessHandler(onDades).recollidaDades();               
}



function aplicacioFiltres(){
  var finalArray=new Array();
  finalArray=dades;  
  /*
  for (c=3;c<dades[0].length; c++){  
      finalArray[c-3]=dades[c];
  }
  //*/
  for (c=0;c<dades[0].length; c++){
    if (dades[1][c]=="Desplegable" || dades[1][c]=="csvFiltre"){
       if($("#sel_"+dades[0][c]).val()!="*"){
         var arr=new Array();
         arr[0]=finalArray[0];
         arr[1]=finalArray[1];
         arr[2]=finalArray[2];         
         var n=2 
         for (r=2;r<finalArray.length; r++){         
             if(finalArray[r][c].indexOf($("#sel_"+dades[0][c]).val())>-1){
                arr[n]=finalArray[r];
                n +=1;
             }
         }
         finalArray=arr;
       }
    }
  }
  return finalArray;
}


//Actualització de les pàgines 
function novaPagina(sentit) {
  numPag +=sentit;  

  divAmplada=$("#div").css("width");
  divAmpladaTar=parseInt(divAmplada)/parseInt(Num_columnes);
  divAmpladaTar=divAmpladaTar-20; //afegir els marges laterals
  nTarFila=(parseInt(parseInt(divAmplada)/divAmpladaTar));
  //alert("amplada contenidor: "+divAmplada+"\nNombre de columnes: "+Num_columnes+"\nAmplada targeta: "+divAmpladaTar+"\nNombre de targes per fila: "+nTarFila);
  var nReg=nTarFila*Num_files;

  var targes=aplicacioFiltres();
  //console.log("targes: "+targes.length+"---"+targes[0].length);  
  //var targes=dades;

  if (numPag<1) {numPag=1};
  var xIni=nTarFila*(numPag-1)*Num_files;
  var xFin=nTarFila*(numPag)*Num_files;  
  if (xFin>targes.length-2) {
      numPag -=1;      
      xIni=nTarFila*(numPag)*Num_files;
      xFin=targes.length-2;
  };    
  
 
  var divDades="";
  var t=0;
  for (var j = xIni; j < targes.length-2; j++) {  
     var plt=plantilles[1][0];
     for (c=0;c<targes[0].length; c++){
        if (plt.indexOf("{{"+targes[0][c]+"}}")>-1){
            var cadena="{{"+targes[0][c]+"}}";
            //plt=plt.replace("{{"+targes[0][c]+"}}",targes[2+j][c]);
            plt=plt.replace(new RegExp(cadena, 'g'), targes[2+j][c]);            
        }
     }
     divDades +=plt;
     t +=1;        
    if (t>=nReg || t>=targes.length-2) {break};     
  }

  //alert(xIni+"---"+xFin);
  if(xIni==0 && xFin>=parseInt(targes.length)-2){
    $("#btnNovaPagina").hide();
  } else {
    $("#btnNovaPagina").css('visibility','visible');      
  }

  if (xIni==0){
    $("#btnB1").css('background-color', '#CACACA');  
    $("#btnB1").css('color', '#FFFFFF');      
    $("#btnB1").prop('disabled', true);      
  } else {
    $("#btnB1").css('background-color', 'inherit');
    $("#btnB1").css('color', 'inherit');      
    $("#btnB1").prop('disabled', false);          
  }
  
  if (xFin>=parseInt(targes.length)-2){
    $("#btnB2").css('background-color', '#CACACA');    
    $("#btnB2").css('color', '#FFFFFF');          
    $("#btnB2").prop('disabled', true);          
  } else {
    $("#btnB2").css('background-color', 'inherit');
    $("#btnB2").css('color', 'inherit');          
    $("#btnB2").prop('disabled', false);          
  }
  
  var regPagina="Registres: "+(xIni+1)+" a  "+xFin+" de "+parseInt(targes.length-2);
  $("#comptadorPagines").html(regPagina);  

  $('#div').html(divDades);
  $(".targeta").css("width",divAmpladaTar);  
  $('#imgtemp').remove();  
}










</script>


<!--div on es carregaran els estils -->
<style id="estil">
</style>


<!--div on es carregaran els scripts -->
<script id="script">
</script>


</head>
<body onload='inicia();'>
  <div class="panel panel-default centered" style="border: 0!important">
    <div class="panel-heading" id="capçalera" hidden>
        <h3 class="panel-title">
           <div class="row">
              <div class="col-md-8">
              </div>
              <div class="col-md-4">
                 <img width="120px" style="float: right;" src="<?= Icona ?>">
              </div>
           </div>
        </h3>
    </div>
    <div>
        <div class='container-fluid'>
             <div class='row filtres' id="filtres" style='font-size:14px; float: left'></div>
             <div style='font-size:14px; float: right; visibility: hidden' id="btnNovaPagina">
                  <input type="button" id="btnB1" value="Anteriors" onclick="novaPagina(-1)"/>
                  <input type="button" id="btnB2" value="Següents" onclick="novaPagina(1)"/>
             </div>             
             <div style='font-size:14px; float: right; margin-right:10px; margin-top:5px' id='comptadorPagines'></div>             
        </div>
    </div>
    <div class="panel-body">
      <div class='container-fluid'>
          <div class='row' id="div"></div>
      </div>
    </div>    
    <div id="imgtemp" style="display: block; margin: 0 auto; width: 50%; height: 300px; background-color: #A0AAD5; opacity:0.7; z-index: 99">
         <input id="btnTancar" type="button" value="X"/>
         <div style="text-align:center; line-height: 100px; font-size: 18px">
             Carregant dades
             <br><img src="http://cdn.nirmaltv.com/images/generatorphp-thumb.gif" style="width: auto; display: block; margin: 0 auto" />
         </div>
    </div> 

  </div>

</body>
</html>











