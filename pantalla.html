<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    
<!-- jQuery -->
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/themes/cupertino/jquery-ui.css">

<!-- <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>  -->
<!--<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>-->
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>     
              
<!--Datatables-->
<!-- jQuery -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" >
<link href="https://cdn.datatables.net/buttons/1.0.3/css/buttons.dataTables.min.css" rel="stylesheet" type="text/css" > 

<!-- Leaflet -->
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>   

<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script> 
   
<script src="https://maps.googleapis.com/maps/api/js?key=<?= Clau_API ?>" async defer></script>
<script src='https://unpkg.com/leaflet.gridlayer.googlemutant@latest/Leaflet.GoogleMutant.js'></script>   

<script src='https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js'></script>
  
<link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.0/MarkerCluster.css">
<link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.0/MarkerCluster.Default.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.0/leaflet.markercluster-src.js" ></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.3.1/leaflet-providers.js" ></script> 

<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>

<!-- Per als mapes del Cartogràfic -->
<script src="https://rawgithub.com/kartena/Proj4Leaflet/master/lib/proj4-compressed.js" type="text/javascript"></script>
<script src="https://rawgithub.com/kartena/Proj4Leaflet/master/src/proj4leaflet.js" type="text/javascript"></script>
 
<!-- buttons -->
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/select/1.2.5/js/dataTables.select.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/dataTables.buttons.min.js"></script>

<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.flash.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.print.min.js"></script>

<!--
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
-->

<!-- Bootstrap -->
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!--scrips relacionats amb el TimeLineMap -->
<!--    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVxmW5MSmBXNniGfdBkiojV16y4_9E5_Q&v=3.exp&sensor=false&language=ca"></script> -->
  <!---<script src="https://openlayers.org/api/OpenLayers.js"></script>-->

    <script type="text/javascript" src="https://edumet.cat/areatac/cartografia/lib/mxn/mxn.js?(googlev3)"></script> 

  <script type="text/javascript" src="https://edumet.cat/areatac/cartografia/lib/timeline-2.3.0.js"></script>
    <script type="text/javascript" src="https://edumet.cat/areatac/cartografia/src/timemap.js"></script>
  <script type="text/javascript" src="https://edumet.cat/areatac/cartografia/src/param.js"></script>  
  <script type="text/javascript" src="https://edumet.cat/areatac/cartografia/src/manipulation.js"></script> 
    <script type="text/javascript" src="https://edumet.cat/areatac/cartografia/src/state.js" ></script>

<!---google_spreadsheet -->
    <script src="https://edumet.cat/areatac/cartografia/src/loaders/json.js" type="text/javascript"></script>
    <script src="https://edumet.cat/areatac/cartografia/src/loaders/google_spreadsheet.js" type="text/javascript"></script> 
<!---google_spreadsheet-->    
  <script src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization', 'version':'1','packages':['timeline']}]}" type="text/javascript" ></script>

<!--script TimeLine-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<!--
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<i class="material-icons">local_parking</i>
<i class="material-icons" style="font-size:36px">local_parking</i>
<i class="material-icons" style="font-size:48px;color:red">local_parking</i>


<link href="https://fonts.googleapis.com/icon?family=Material+Icons"  rel="stylesheet">

<i class="material-design-icons//1x_web/"  style="font-family: 'Material Icons'">accessibility</i>
<i class="material-design-icons//2x_web/"  style="font-family: 'Material Icons'">face</i>
<i class="md-icon dp48" style="font-family: 'Material Icons'">accessibility</i>
-->


<style>
.centered{
    width: 85%;
    /*height: 410px;*/
    position: absolute;
    /*top:-200px;*/
    top: 40px;
    left: 0;
    right: 0;
    margin: auto;
}

.opcio{
  color:blue;
}

.nourl{
   pointer-events: none;
   cursor: default;
   text-decoration:none;
}

.zoom {
  width: 35px; 
  height: 35px; 
  margin: 5px;
}

.noZoom {
  width: 0px; 
  height: 35px; 
  margin: 5px;
}

.selFiltre{
   height: 35px; 
   font-size: 14px; 
   margin: 2px 3px;
}

#tblDades{
    font-size:12px;
    line-height: 1;
}


#map {
   height: 100%;
}
   

#divPresTaula, #divPresTargetes  {
   height: 100%;
}

/* Optional: Makes the sample page fill the window. */
html, body {
   height: 90%;
   margin: 0;
   padding: 0;
}

#divTitols{
  font-size:1.5em;
  line-height: 35px;
  vertical-align: middle;  
}

.tblResultats{
    border: 1px solid black;
    width: 90%;
    margin: 0 auto;  
    max-height: 250px;
    overflow-y:scroll;        
}

.tblEdit{
    font-size:15px;
}

th{
 background-color: #cacaca;
}

tr:hover {
  background-color: #d9d9d9;
}

#tblEditReg{
 background-color: #ffffff;
 font-size: 11px;
}

#tblEditReg td{
 padding: 5px 0px;
}

#tblEditReg input, textarea{
 background-color: #f9efef;
 /*background-color: #ac1a0e1a;*/
}

#tblEditReg th{
 background-color: #cacaca;
}

#tblEditReg tr:hover {
  background-color: #d9d9d9;
}

.modal-dialog{
   background-color: white;
   width: 70%;
}

.modal-header{
   background-color: rgb(224, 236, 247);
}

.modal-body{
  /*min-height: 500px;*/
}

.modal-footer{
  clear:both;
}

<!--Mapa-->

   .laLlegenda{
   }

   #llegendaMapa {
     font-family: Arial, sans-serif;
     background: #ffffff;
     padding: 10px;
     margin: 10px;
     border: 1px solid #000;
  }

  .laSuperposicio{
  }

  #Superposicio {
     font-family: Arial, sans-serif;
     background: rgba(0, 0, 255, 0.5); 
     margin: -5px;
     width:400px;
     height:1000px;
  }


<!--Style timeLineMaps-->

    div#timelinecontainer{
    width: 100%;
    height: 60%;
  background: #B7C1CF;  
    }
  
    div#mapcontainer {
    width: 100%;
    height: 40%;
  background: #CFB7B7;  
    } 
    
    div#timeline{
  left:2%;  
    width: 98%;
    height: 100%;
    font-size: 11px;
    background: #CCCCCC;
    }        
    
    div#map {
  left:2%;  
    width: 98%;
    height: 100%;
    background: #EEEEEE;
    }
  
  div#global_menys_alçada{
  position:absolute;
  left:1%;
  top:150px;  
  z-index:100;
  }
    
  div#global_mes_alçada{
  position:absolute;
  left:1%;
  top:164px;  
  z-index:100;
  }

  div#mapa_menys_alçada{
  position:absolute;
  left:1%;
  top:440px;  
  z-index:100;
  }

  div#mapa_mes_alçada{
  position:absolute;
  left:1%;
  top:454px;  
  z-index:100;
  }

  div#timeline_amplada_text {
  /*position:absolute;*/
  left:4%;
  top:60px; 
  z-index:200;
  }

  div#timeline_amplada {
  /*position:absolute;*/
  left:4%;
  top:75px; 
  z-index:300;
  }
    
    div.infodescription {
    font-style: normal;
    width: 300px;
    }

    p{font-family: Arial;
    font-size:1em;}
    .esq{float:left;}
    .dret{padding-left:10px;margin-left: 130px;}
    a{text-decoration: none;color:#AD2114;}
    a:hover{text-decoration: none;color:grey;}
</style>  

</head>

<body>

   <div id="ocult" style=" display:none;">
   </div>

    <div id="imgtemp" style="position: absolute; margin-left: 25%; margin-top: 5%; width: 50%; height: 300px; background-color: #A0AAD5; opacity:0.7; z-index: 99; font-size:1em">
         <input id="btnTancar" type="button" value="X"/>
         <div style='text-align:center; line-height: 100px'>
             Carregant dades
             <br><img src="https://drive.google.com/uc?id=1_O7dANSqSFwgMIC0m7QxTzOD0q-V_nac" style="width: auto; display: block; margin: 0 auto" /> 
         </div> 
    </div>
    <div class="panel-heading" id="Capçalera" style="visibility: hidden;">
        <h3 class="panel-title">
            <div class="row">
               <div class="col-md-8">
                  <h3><?= Titol_aplicacio ?></h3>
               </div>
               <div class="col-md-4">
                  <img width="120px" style="float: right;" src="<?= Icona ?>">
               </div>
            </div>
        </h3>
    </div>
         
    <div class='container-fluid'>

           
        <div class='row filtres' style='margin:5px 0px;visibility: hidden; float:left; width:85%' id="divFiltres"></div>      
        
        <img src='https://drive.google.com/uc?id=1X1tZEQ8PYYhpQ2nUijq0cwJB5mbqxYpw' id="imgInfo" style="width:38px; margin:5px 5px; float:right; visibility: hidden" onclick="activaInfo()"/>
        <img alt="Fulls de càlcul de Google" src="//ssl.gstatic.com/docs/doclist/images/mediatype/icon_1_spreadsheet_x32.png" id="fullCalcul" style="width:38px; margin:5px 5px; float:right; visibility: hidden" onclick="obrirFullCalcul('<?= id ?>')"/>        
        <input hidden id='idFullCalcul' name='idFullCalcul' value='<?= id ?>'/>
        <input hidden id='colconfig' name='colconfig' value='<?= colconfig ?>'/>
        <input hidden id='fltr' name='fltr' value='<?= fltr ?>'/>        
        <input hidden id='fltrPol' name='fltrPol' value='<?= fltrPol ?>'/>                
        <div id="bloc_capçalera_2" hidden>
            <div class='row filtres' style='margin:5px 0px 5px 0px;visibility: hidden; float:left;' id="divTipus">             
                <div id="divSelTipus" style="margin-left:2px;float:left;visibility: hidden; float:left;">
                </div>
                <div class='row filtres' style='margin-left:5px; margin-right:5px; visibility: hidden; float:left' id="divMapaBase"></div> 
                <input id='botoCentrar' src="https://drive.google.com/uc?id=1jVkYeRZiImemNB9QVHJjkbR2xaYgz4mz" class="noZoom" type="image" onClick="centrar()" style='float:left; margin-left:10px; margin-top:0px'> 
            </div> 
            
            <div class='row titols' style='margin:5px 50px; float:left; text-align:center; visibility: hidden' id="divTitols">
            </div>             
            <div style='font-size:14px; float: right;  margin:5px 0px; visibility: hidden' id="btnNovaPagina">
                <input type="button" id="btnB1" value="Anteriors"/>
                <input type="button" id="btnB2" value="Següents"/>
            </div>
            <div style='font-size:14px; float: right; margin-right:10px; margin-top:5px' id='comptadorPagines'></div>
        </div>
        <div id="divPresTaula" style="clear:both; width: 100%; margin-top:5px">
             <div id="userEmail"></div>
             <div id="divFormTaula"></div>
        </div>
        <div id="divPresTargetes" style="clear:both; width: 100%; margin-top:5px"></div>        
        <div id="divPresTimeMap" style="clear:both; width: 100%; margin-top:5px"></div>
        <div id="divPresTimeLine" style="clear:both; width: 100%; margin-top:5px"></div>        
        <div id='divBotons' hidden >
            <div style="width:50%; float: left">
               <? if(Permetre_edicio_taula=='S') { ?>            
                   <? if(prmEdit=='S') { ?>
                       <input type='button' class='btn btn-primary' id='btnPermis' style='width: 25%; display: block; margin: 0 auto' onclick="enviarGenerar()" value='Enviar respostes'/>
                   <? } else { ?>
                       <input type='button' class='btn btn-primary' id='btnPermis' style='width: 25%; display: block; margin: 0 auto; color: red' value='Enviar respostes'  onclick="missatgeError('No esteu autoritzat a guardar canvis')" title='No esteu autoritzat a guardar canvis'/>          
                   <? } ?>
               <? } ?>                   
            </div>
            <form>
               <div id='btnTancarApl' style='width:50%; float: right; visibility: hidden'><button class='btn btn-primary' style="background-color:grey; width: 25%; display: block; margin: 0 auto"  onclick="self.close()"> Tancar </button></div>
            </form>
        </div>        
    </div>
 
    <div id="map" style="clear:both; margin: 5px 0px" hidden></div>      

<!-- Modal -->
    <div id="finestraInfo" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" width='90%'>
        <div class="modal-dialog">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3 id="modalHeader">Resultats del procés de desar dades</h3>
            </div>
            <div class="modal-body" id="missatge">
                <p>One fine body…</p>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Tancar</button>
            </div>
        </div>
    </div>
    
</body>    


<!--scripts incials-->
<script>
var userEmail='';
var numPag=1;
var Num_files_capçalera=3;
var plantilla_1="";
var plantilla_2="";
var bloc_capçalera_2="N";
var row_org=new Array();
var nTarFila=0;
var row_var=new Array();
var row_tip=[];
var plantilles=new Array();
var finalArray=new Array();
var Permetre_canvi_presentacions='N';  
var Permetre_canvi_mapa='N';
var Tipus_mapa="Google Maps (roadmap)";
var mapa_actual=Tipus_mapa;
var tipus_mapa_actual;
var tipus="";
var filtresActius=0;
var informacio="1";
var row_poligons=[];
var poligons=[];
var arrayCheckboxesID;
var arrayCheckboxesValue;
var numCheckboxes=0;
var checkboxPoligonsValue;
var checkboxClustersValue;
var checkboxHeatmapValue;
var checkboxMarcadorsValue;
var oms;
var heat;
var locations=[];

//variables relacionades amb la presentació de targetes
var Num_files=0;
var Num_columnes=0;

//per determinar fer global la variable que guardarà la columna per la que s'ordenaran les matrius en el moment de construir els desplegables 
var colOrd=0; 
var Columna_id="";
var Capçalera='N';
var permisEdit='N';

//relacionats amb el tipus mapa
var numColAgrupa=-1;
var numColLatitud=0;
var numColLongitud=0;
var numColDataIni=0;
var numColDataFin=0;
var numColDescripcio=0;
var numColTitol="";
var numColColorMark="";
var numColNomLlegendaMapa=-1;
var numColBloc=0;
var centres=[];
var agrupaCentres=[];
var map;
var mapHis;
var marcadors=[];
var markerCluster;
var Centre_mapa="41.71,1.82";
var Zoom_automatic="S";
var Zoom_inicial=0;
var Zoom_max=19;
var Clusters;
var Mostra_clusters="S";
var Mostra_poligons="N";
var Mostra_densitat="N";
var Casella_clusters="N";
var Casella_poligons="N";
var Casella_densitat="N";
var Visualitzar_errors="N";
var bounds;
var bounds_all;
var iniciantMapa=true;
var Marcador_defecte_color="#AC2010";
var Marcador_defecte_forma="";
var Posicio_llegenda="SENSE_LLEGENDA";
var Proveidor_mapes="OpenStreetMap.Mapnik";
var llegendes="";
var markers;
var proveidor;
var nomProveidor=["OpenStreetMap.Mapnik","OpenStreetMap.BlackAndWhite","OpenStreetMap.HOT",
"Google Maps (roadmap)","Google Maps (satellite)","Google Maps (hybrid)","Google Maps (terrain)",
"ICGC (Topogràfic)","ICGC (Topogràfic_Gris)","ICGC (Topogràfic_1_5000)","ICGC (OrtoFoto)","ICGC (OrtoFoto_Infraroja)","ICGC (Vol_Americà_1945)",
"Wikimedia",
"Esri.WorldStreetMap","Esri.WorldTopoMap","Esri.WorldImagery","Esri.WorldShadedRelief","Esri.WorldGrayCanvas",
"OpenTopoMap",
"OpenMapSurfer.Roads","OpenMapSurfer.Grayscale",
"Hydda.Full","Hydda.Base",
"Stamen.Toner","Stamen.TonerBackground","Stamen.TonerLite","Stamen.Watercolor","Stamen.Terrain","Stamen.TerrainBackground",
"MtbMap",
"CartoDB.Positron","CartoDB.PositronNoLabels","CartoDB.DarkMatter","CartoDB.DarkMatterNoLabels","CartoDB.Voyager","CartoDB.VoyagerNoLabels","CartoDB.VoyagerLabelsUnder",
"HikeBike.HikeBike","HikeBike.HillShading"];
var proveidorWMS=[0,0,0,
0,0,0,0,
1,1,1,1,1,1, // ICGC
0,
0,0,0,0,0,
0,
0,0,
0,0,
0,0,0,0,0,0,
0,
0,0,0,0,0,0,0,
0,0];
var tipusICGC;

var pixelsIco=24;
var escalaIco=1.5;
var path_defecte="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z";

// ICGC
var crs25831 = new L.Proj.CRS('EPSG:25831','+proj=utm +zone=31 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs',
{
resolutions: [1100, 550, 275, 100, 50, 25, 10, 5, 2, 1, 0.5, 0.25]
}
);

var Topogràfic = L.tileLayer.wms("http://mapcache.icc.cat/map/bases/service?", {
layers: 'topo',
format: 'image/jpeg',
crs: crs25831,
continuousWorld: true,
attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',
});

var Topogràfic_Gris = L.tileLayer.wms("http://mapcache.icc.cat/map/bases/service?", {
layers: 'topogris',
format: 'image/jpeg',
crs: crs25831,
continuousWorld: true,
attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',
});

var Topogràfic_1_5000 = L.tileLayer.wms("http://geoserveis.icgc.cat/icc_mapesbase/wms/service?", { // Mapa topogràfic de Catalunya 1:5.000 vigent
layers: 'mtc5m',
format: 'image/jpeg',
crs: crs25831,
continuousWorld: true,
attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',
});

var OrtoFoto = L.tileLayer.wms("http://mapcache.icc.cat/map/bases/service?", {
layers: 'orto',
format: 'image/jpeg',
crs: crs25831,
continuousWorld: true,
attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',
});

var OrtoFoto_Infraroja = L.tileLayer.wms("http://geoserveis.icgc.cat/icc_mapesbase/wms/service?", { // Ortofoto infraroja de Catalunya 1:2.500 vigent
layers: 'ortoi25c',
format: 'image/jpeg',
crs: crs25831,
continuousWorld: true,
attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',});

var Vol_Americà_1945 = L.tileLayer.wms("http://geoserveis.icgc.cat/icc_ortohistorica/wms/service?", { // Ortofoto de Catalunya del Vol americà sèrie A 1:10.000 (1945-46)
layers: 'ovaa10m',
format: 'image/jpeg',
crs: crs25831,
transparent: true,
continuousWorld: true,
attribution: 'Institut Cartogràfic i Geològic de Catalunya -ICGC',
});

//Variables relacionades amb timeLineMap
//var tm="";
var titol_pagina ="prova";
var tipus='basic';
var alcada_select="550";
var bandaTemps="35";
var etiqueta="";
var visColumna = "Visible";
var descColumna = "Descripcio";
var latColumna = "latitud";
var lonColumna = "longitud";
var locColumna = "localitat";
var adrColumna = "adreça";
var enllaçColumna = "enllaç";
var mediaColumna = "Imatge";
var idColumna = "id";
var mapaColor = "red";
var dataInici = "dataIni";
var dataFinal = "dataFin";
var quadreWidth = "1000";
var quadreHight = "550";

var avui = new Date();
avui=avui.getFullYear()+ "/" + (avui.getMonth() +1)+"/" +avui.getDate() ;

var banda = [];
var banda = ["Mil·lisegon","Segon","Minut","Hora","Dia","Setmana","Mes","Any","Decada","Centuria","Mil·leni"];
var bandIntervals = [];
var bandIntervals = ["Mil·lisegon","seg","min","hr","day","wk","mon","yr","dec","Centuria","Mil·leni"];
var finestra_temporal=banda[bandaTemps];
var bandIntervals=bandIntervals[bandaTemps];

/*Timeline.DateTime.MILLISECOND=0;
Timeline.DateTime.SECOND=1;
Timeline.DateTime.MINUTE=2;
Timeline.DateTime.HOUR=3;
Timeline.DateTime.DAY=4;
Timeline.DateTime.WEEK=5;
Timeline.DateTime.MONTH=6;
Timeline.DateTime.YEAR=7;
Timeline.DateTime.DECADE=8;
Timeline.DateTime.CENTURY=9;
Timeline.DateTime.MILLENNIUM=10;
Timeline.DateTime.EPOCH=-1;
Timeline.DateTime.ERA=-2;
//*/

colors_objectes= [];
colors_objectes= ['green', 'orange', 'blue','red','purple','ltblue','pink','green', 'orange', 'blue','red','yelow'];
inici =[];
fin = [];
titol = [];
titol_curt = [];
bloc = [];
bloc_nom = [];
bloc_color = [];
bloc_color= ['green', 'orange', 'blue','red','purple','ltblue','pink','green', 'orange', 'blue','red','yelow'];
//bloc_unic = [[1,1]];
lat = []; 
lon = []; 
media= [];
text= [];
poblacio= [];
adreça= [];
dades= [];
enllaç= [];
targetes= [];
totalfiles = 0;
longitud=[];
latitud=[];


data_inici = new Date();
data_inici =data_inici.getFullYear()+ "/" + (data_inici.getMonth() +1)+"/" +data_inici.getDate() ;

//final codi declaracio de variables de timeLineMap

//Pantalla d'espera per carregar dades
$(document).ready(function(){ 
   $("#btnTancar").click(function(){
        //$('#imgtemp').remove(); 
        $('#imgtemp').css("visibility","hidden");           
   });  
   $("#btnB1").click(function(){
        numPag =numPag-1;  
        aplicacioFiltres();     
   });     
   $("#btnB2").click(function(){
        numPag =numPag+1;  
        aplicacioFiltres();             
   });         
});



var time = 100;
var rellotge=setInterval(test, 100);

function test() {
  time -=1;
  if(time < 0) {
    $('#imgtemp').css("display","none");       
    clearInterval(rellotge);       
  }
}




function carregaDades(opc,valors){
  /*
  console.log(opc,valors);
  var valors=JSON.stringify(valors);
  console.log(valors)  
  valors=valors.split();
  console.log(valors)    
  //*/
  switch (opc){
    case 'recollidaVariables':    
      //google.script.run.withSuccessHandler(onVariables).recollidaVariables(id,colconfig,fltr);    
      google.script.run.withSuccessHandler(onVariables).recollidaVariables(valors);    
      break;

    case 'recollidaPlantilles':    
      //google.script.run.withSuccessHandler(onPlantilles).recollidaPlantilles(id,colconfig);  
      google.script.run.withSuccessHandler(onPlantilles).recollidaPlantilles(valors);        
      break;

    case 'recollidaPoligons':
      //google.script.run.withSuccessHandler(onPoligons).recollidaPoligons(id,colconfig,fltrPol);          
      google.script.run.withSuccessHandler(onPoligons).recollidaPoligons(valors);                
      break;

    case 'recollidaDades':
      //google.script.run.withSuccessHandler(onDades).recollidaDades(id,colconfig,fltr); 
      google.script.run.withSuccessHandler(onDades).recollidaDades(valors);       
      break;

    case 'comprovacioPermis':
      //google.script.run.withSuccessHandler(onPermis).comprovacioPermis(id,colconfig);   
      google.script.run.withSuccessHandler(onPermis).comprovacioPermis(valors);   
      break;

    case 'salvarDades':
      //google.script.run.withSuccessHandler(onSalvarDades).salvarDades(id,colconfig,regArray);             
      google.script.run.withSuccessHandler(onSalvarDades).salvarDades(valors);             
      break;
    case 'recollidaDadesSub':
      //google.script.run.withSuccessHandler(onTimeLine).recollidaDadesSub(pestanya,nomColCerca,valCerca,id,colconfig);
      google.script.run.withSuccessHandler(onTimeLine).recollidaDadesSub(valors);      
      break;

    case 'obreHistoria':
      //google.script.run.withSuccessHandler(onHistoryMap).recollidaDadesSub(pestanya,nomColCerca,valCerca,id,colconfig);
      google.script.run.withSuccessHandler(onHistoryMap).recollidaDadesSub(valors);      
      break;      
      
  }
}


function inicia(){
    var id=$("#idFullCalcul").val();
    var colconfig=$("#colconfig").val();      
    var fltr=$("#fltr").val();            
    var valors=[id,colconfig,fltr];
    carregaDades('recollidaVariables',valors);
}

function obrirFullCalcul(id_full){
   window.open('https://docs.google.com/spreadsheets/d/'+id_full,'_blank');
}


/*
function fnBoto(id_registre,columna,id,url){
   //url=row_org[id_registre][columna];
   //var org=row_org[id_registre][columna];
   //console.log("id: "+id_registre+"\nColumna: "+columna+"\nID: "+id+"\nURL: "+url);
   $('#imgtemp').css('display','block');
   $('#imgtemp').css("visibility","visible");   
   //$("*").css("cursor","wait");      
   if (row_org[0][columna]=="Fitxa"){
      if(url==""){      
         var id=$("#idFullCalcul").val();
         var colconfig=$("#colconfig").val();    
         google.script.run.withSuccessHandler(onFitxa).crear_fitxer_apadrina(id_registre,id,colconfig);     
      } else {
         obreFitxa(url);
      }
   } else {
      obreFitxa(url);
   }
}

function onFitxa(retorn){
   //alert(retorn);
   var fil=retorn[0];
   var col=retorn[1];
   var url=retorn[2];   
   var ele=retorn[3]; 
   var id_registre=retorn[4]; 

   //actualitzar taula amb les dades de la url creada
   $("#"+"btn_"+fil+"_"+col).attr('name', url);

   //desactivar pantalla d'espera
   $('#imgtemp').css('display','none');
   //$("*").css("cursor","default");    

   $("#modalHeader").html("Creació de fitxa de: "+ele);
   var divMissatge="Fitxa creada correctament";
     divMissatge +="<br>S'han afegit, amb permís d'edició del document, els usuaris crp i els gestors de l'aplicació, entre ells sose@xtec.cat";   
     divMissatge +="<br><br>Traspasseu la propietat del document al usuari <strong>sose@xtec.cat</strong>";   
     divMissatge +="<br><br>Afegiu els usuaris que considereu han de poder afegir/modificar informació en el document";        
     divMissatge +="<br><br><a href='"+url+"' target='_blank'>Obrir la fitxa</a>";   
   $("#missatge").html(divMissatge);
   $('#finestraInfo').modal('show');
   //$("*").css("cursor","default");    
      
   $("#tblResultats").css({
     "border":"1px solid black",
     "width": "90%",
     "margin": "0 auto",  
     "max-height": "250px",
     "overflow-y": "scroll"});
}

function obreFitxa(url){
  $('#imgtemp').css('display','none');
  //$("*").css("cursor","default");     
  window.open(url);  
}
//*/


//Càrrega de les variables 
function onVariables(variables) {
   //console.log(variables);
   row_var=variables;
   for (v=0;v<row_var.length;v++){
      //console.log(row_var[v][0]);
      valVar=row_var[v][1];
      if (valVar.indexOf("'")>-1){      
          valVar=valVar.replace(new RegExp("'", 'g'),"&apos;"); 
      }
      eval(row_var[v][0]+"='"+valVar+"'");      
   }
   if (Capçalera=='N'){
     $("#Capçalera").css("display","none");
   } else {
     $("#Capçalera").css("visibility","visible");          
     $("#Capçalera").css("display","block");   
   }
   
   //console.log(Correu_gestors+"\n"+userEmail);
   if (Correu_gestors.indexOf(userEmail)>-1 && userEmail!=""){
       $("#fullCalcul").css("visibility","visible");
   } else {
       $("#fullCalcul").remove();   
   }

   //determinar la columna de la latitud i la logintud si n'hi ha
   numColLatitud=parseInt(Columna_latitud.charCodeAt(0)-65);
   numColLongitud=parseInt(Columna_longitud.charCodeAt(0)-65);  
   
   //Creació del select de Mapa Base
   var strBase="<select id='mapaBase'  style='float:left; width:275px; height: 35px; font-size: 14px;' onChange='canviaMapaBase(this.value)'>";
   strBase += "<option selected disabled>Tipus de mapa</option>";
   for(i=0; i<nomProveidor.length; i++){
      strBase +="<option value="+i+">"+nomProveidor[i]+"</option>";
      }
   strBase +="</select>";
   $("#divMapaBase").html(strBase);

   //Creació del select de presentacions si hi ha més d'una
   row_tip=Presentacions_permeses.split(",");   
   if (row_tip.length>1){
       var str="<select id='selTipus' onchange='aplicaTipus(this.value)' style='float:left; width:275px; height: 35px; font-size: 14px;'>";
           for(i=0; i<row_tip.length; i++){
              str +="<option value='"+row_tip[i]+"'>Presentació en forma de "+row_tip[i].toUpperCase()+"</option>";
            }
            str +="</select>";
      $("#divSelTipus").html(str);
      $("#divSelTipus").css("visibility","visible");         
      $("#divTipus").css("visibility","visible");   
   }
   
   if (Visualitzar_boto_tancar=='S'){
      $("#btnTancarApl").css("visibility","visible");         
   }
   
   if(Clusters!=undefined) {
      Mostra_clusters=Clusters;
   }

   //var plantilla=plantilles[0][1];   
   //recollir les dades despres de les variables per garantir que està el nombre de files a mostrar
   var id=$("#idFullCalcul").val();
   var colconfig=$("#colconfig").val(); 
   

    if(Tipus_mapa.search("ICGC")!=-1) {
        $("#map").show();
        tipusICGC=Tipus_mapa.replace("ICGC (","");
        tipusICGC=tipusICGC.replace(")","");
        var center = [41.82045, 1.54907];
        map = L.map('map', {
                            layers:[eval(tipusICGC)],
                            crs: crs25831,
                            continuousWorld: true,
                            worldCopyJump: false,
                            center: center,
                            zoom: 1
                            });
        tipus_mapa_actual=1;
    } else {  
        map = L.map('map'); 
        if(Tipus_mapa.search("Google")!=-1) {
        var tipusGoogle=Tipus_mapa.replace("Google Maps (","");
        tipusGoogle=tipusGoogle.replace(")","");
        proveidor=L.gridLayer.googleMutant({ type: tipusGoogle }).addTo(map);         
        } else {
        proveidor= new L.tileLayer.provider(Tipus_mapa);
        } 
        map.addLayer(proveidor); 
        tipus_mapa_actual=0;
    }
    markers = L.markerClusterGroup(); 
    if (Mostra_clusters=='N') {
        oms = new OverlappingMarkerSpiderfier(map,{nearbyDistance:1});
        oms.addListener('spiderfy', function(markers) {
            map.closePopup();
        });
    }
    //google.script.run.withSuccessHandler(onPlantilles).recollidaPlantilles(id,colconfig);  
    var valors=[id,colconfig];
    carregaDades('recollidaPlantilles',valors);      
}


function canviaMapaBase(numMapa) {
    if(tipus_mapa_actual==0){
        map.removeLayer(proveidor);
    } else {
        map.removeLayer(eval(tipusICGC));
    }
    if(proveidorWMS[numMapa]==0) {
        if(nomProveidor[numMapa].search("Google")!=-1) {
            var tipusGoogle=nomProveidor[numMapa].replace("Google Maps (","");
            tipusGoogle=tipusGoogle.replace(")","");
            proveidor=L.gridLayer.googleMutant({ type: tipusGoogle }).addTo(map);         
        } else {
            proveidor= new L.tileLayer.provider(nomProveidor[numMapa]);
        }  
        map.addLayer(proveidor);
        tipus_mapa_actual=0;
    } else {
        var nouMapa=nomProveidor[numMapa].replace("ICGC (","");
        nouMapa=nouMapa.replace(")","");
        map.addLayer(eval(nouMapa));
        tipusICGC=nouMapa;
        tipus_mapa_actual=1;
    }
}



//Càrrega dels estils de la plantilla
function onPlantilles(plt) {
   if (plt.length<row_tip.length){
      var missatge=[];
      missatge[0]=[];
      missatge[0][0]="No s'han trobat les pestanyes de les següents plantilles indicades al full de configuració<br><br>Reviseu aquesta informació";
      missatge[0][1]="Tipus de presentació autoritzat";      
      missatge[0][2]="Plantilla indicada";            
      missatge[0][3]="Situació";                  

      for (t=0;t<row_tip.length;t++){
        missatge[t+1]=[];      
        missatge[t+1][0]=row_tip[t];      
        missatge[t+1][1]="";            
        missatge[t+1][2]="No trobada";                        

        for (p=0;p<plt.length;p++){
          if (plt[p][0].toLowerCase()===row_tip[t].toLowerCase()){
            missatge[t+1][1]=plt[p][1];            
            missatge[t+1][2]="Trobada";              
            break;         
          }
        }

      }

      mostraErrades(missatge);
   }
   for (p=0;p<plt.length;p++){ 
      plantilles[p]=[];
      plantilles[p][0]=plt[p][0]; //tipus
      plantilles[p][1]=plt[p][2]; //titol
      plantilles[p][2]=[];      
      plantilles[p][2][0]=plantilles[p][2][1]=plantilles[p][2][2]=plantilles[p][2][3]=plantilles[p][2][4]=plantilles[p][2][5]="" ;
      for (c=0; c<plt[p][3][0][0].length; c++){
        if (plt[p][3][0][c]!=undefined){
           switch (plt[p][3][0][c].toLowerCase()){
           case "plantilla": 
              plantilles[p][2][0] +=plt[p][3][1][c];
              break;
           case "botons":
              plantilles[p][2][1] +=plt[p][3][1][c];           
              break;
           case "<style>":
              plantilles[p][2][2] +=plt[p][3][1][c];           
              break;           
           case "<script>":
              plantilles[p][2][3] +=plt[p][3][1][c];           
              //console.log(plt[p][3][1][c])
              break;
           case "<div>":
              plantilles[p][2][4] +=plt[p][3][1][c];   
              break;
           case "info":
              plantilles[p][2][5] +=plt[p][3][1][c];   
              break;              
           case "llegenda":
              plantilles[p][2][6]=plt[p][3][1][c];
              break;
           }
        }
      }             
   }
   tipus=plantilles[0][0];
   var id=$("#idFullCalcul").val();
   var colconfig=$("#colconfig").val();
   var fltrPol=$("#fltrPol").val();             
   //console.log(id+"\n"+colconfig);
   //google.script.run.withSuccessHandler(onPoligons).recollidaPoligons(id,colconfig,fltrPol);      
   valors=[id,colconfig,fltrPol];
   carregaDades("recollidaPoligons",valors);         
}


//Visualitza les primeres fitxes
function onPoligons(dad) {
  //console.log(dad);
  row_poligons=dad;
  var id=$("#idFullCalcul").val();
  var colconfig=$("#colconfig").val();
  var fltr=$("#fltr").val();             
  //google.script.run.withSuccessHandler(onDades).recollidaDades(id,colconfig,fltr);   
  var valors=[id,colconfig,fltr];
  carregaDades('recollidaDades',valors);     
}




function aplicaTipus(){

  if (plantilles.length==1){
     tipus=plantilles[0][0];
  } else {
     tipus=$("#selTipus").val();     
  }
  if (tipus=="mapa" && Permetre_canvi_mapa=='S') {
     $('#divMapaBase').css("visibility","visible"); 
  } else {
     $('#divMapaBase').css("visibility","hidden"); 
  } 
    
  if (tipus=="mapa" && Zoom_automatic=='N') {
      $('#botoCentrar').removeClass("noZoom").addClass("zoom");
  } else {
      $('#botoCentrar').removeClass("zoom").addClass("noZoom");
  }

  $('#imgtemp').css('display','block');
  $('#imgtemp').css("visibility","visible");   
  //$("*").css("cursor","wait");   
  //determinar la plantilla a aplicar
  for (p=0;p<plantilles.length;p++){
    if (plantilles[p][0]==tipus){
       plantilla_1=plantilles[p][2][0];       
       plantilla_2=plantilles[p][2][1];              
       $('#divEstil').html(plantilles[p][2][2]);  
       script=plantilles[p][2][3].replace(new RegExp('""', 'g'),'"');
       $('#divScript').html(script);      
       $('#divDiv').html(plantilles[p][2][4]);  
       //console.log(plantilles[p][1])
       if (plantilles[p][1]!=""){
          $("#divTitols").html(plantilles[p][1]);
          $("#divTitols").css("visibility","visible");         
       } else {
          $("#divTitols").remove(); 
       }

       if (plantilles[p][2][5]!="undefined"){              
          //info=plantilles[p][2][5].replace(new RegExp('""', 'g'),'"');       
          informacio=plantilles[p][2][5];                 
          if (informacio.length>0){
              $("#imgInfo").css("visibility","visible");                     
          }
       } else {
          informacio="";                        
          $("#imgInfo").css("visibility","hidden");                                   
       }


       if (plantilles[p][2][6]!="undefined"){              
          llegendes=plantilles[p][2][6];                 
       }

       break;
    }
  }
  if (plantilles.length>1 || plantilles[0][1].length>0){
      $("#bloc_capçalera_2").show();            
  }
  creaTipus();  
}


function creaTipus(){
   $('#imgtemp').css('display','block');
   //$("*").css("cursor","wait");   

   //alert("creaTipus: "+tipus)
   switch (tipus){
   case "mapa":
     $("#btnNovaPagina").css("visibility","hidden");         
     $("#comptadorPagines").css("visibility","hidden");                 
     $("#divBotons").css("display","none");                     
     $("#divPresTaula").css("display","none");                               
     $("#divPresTargetes").css("display","none");                      
     $("#divPresTimeMap").css("display","none");               
     $("#divPresTimeLine").css("display","none");                   
     $("#map").css("visibility","visible");               
     $("#map").css("display","block");   
     $("#map").css("margin-left","0px");        
     break;
   case "taula":
     $("#btnNovaPagina").css("visibility","hidden");           
     $("#comptadorPagines").css("visibility","hidden");                      
     $("#divBotons").css("visibility","visible");       
     $("#divBotons").show();                          
     $("#map").css("display","none");                     
     $("#llegendaMapa").css("display","none");                         
     $("#divPresTimeMap").css("display","none");               
     $("#divPresTimeLine").css("display","none");                   
     $("#divPresTaula").css("display","block");                          
     $("#divPresTargetes").css("display","none");       
     break;
   case "targetes":
     $("#divBotons").css("visibility","hidden");    
     $("#comptadorPagines").css("visibility","visible");                 
     $("#btnNovaPagina").css("visibility","visible");                 
     $("#map").css("display","none");                          
     $("#llegendaMapa").css("display","none");                              
     $("#divPresTimeMap").css("display","none");               
     $("#divPresTimeLine").css("display","none");                  
     $("#divPresTaula").css("display","none");                          
     $("#divPresTargetes").css("display","block");            
     break;      
   case "timemap":
     $("#btnNovaPagina").css("visibility","hidden");         
     $("#comptadorPagines").css("visibility","hidden");                 
     $("#divBotons").css("display","none");                     
     $("#divPresTaula").css("display","none");                               
     $("#divPresTargetes").css("display","none");            
     $("#map").css("display","none");       
     $("#llegendaMapa").css("display","none");                              
     $("#divPresTimeLine").css("display","none");               
     $("#divPresTimeMap").css("display","none");               
     $("#divPresTimeMap").css("display","block");                              
     break;      
   case "timeline":
     $("#btnNovaPagina").css("visibility","hidden");         
     $("#comptadorPagines").css("visibility","hidden");                 
     $("#divBotons").css("display","none");                     
     $("#divPresTaula").css("display","none");                               
     $("#divPresTargetes").css("display","none");            
     $("#map").css("display","none");
     $("#llegendaMapa").css("display","none");                              
     $("#divPresTimeMap").css("display","none");               
     $("#divPresTimeLine").css("visibility","visible");               
     $("#divPresTimeLine").css("display","block");                              
     break;           
   }
   aplicacioFiltres();
   //$("*").css("cursor","default"); 
   $('#imgtemp').css('display','none');
}


//Comprovació dels permisos 
function comprovacioPermis(){
    var id=$("#idFullCalcul").val();
    var colconfig=$("#colconfig").val();  
    //console.log(id+"----"+colconfig);
    //google.script.run.withSuccessHandler(onPermis).comprovacioPermis(id,colconfig);   
    var valors=[id,colconfig];
    carregaDades('comprovacioPermis',valors);       
}


//Càrrega de les variables 
function onPermis(permis) {
  userEmail=permis[0];
  Acces_restringit=permis[1];  
  permisEdit=permis[2];

  var str='';
  if (Acces_restringit=='S') {
      str="<h4>Llistat de registres relacionats amb el compte: <strong><font color='red'>"+userEmail+"</font></strong></h3>";
  }      
  $("#userEmail").html(str);
  
  if (permisEdit=='S'){
      $("#btnPermis").show();    
      $("input").prop('disabled', false);     
      var paginacio=false;      
  } else {
      $("#btnPermis").prop('disabled', true);                     
      var paginacio=true;            
  }
  //aplicacioFiltres()
  //presentaDades();
}

function ordenaArray(a, b) {
    if (a[colOrd] === b[colOrd]) {
        return 0;
    } else {
        return (a[colOrd] < b[colOrd]) ? -1 : 1;
    }
}

//Càrrega dels filtres 
function creacioFiltres(dades){
  //alert(dades)
  var f=0;
  var flt="";  
   
  for (c=0;c<dades[0].length; c++){
    var pas=false;  
    if (dades[1][c].toLowerCase().indexOf("selfiltre")>-1){
      var row=[];
      var itemsFound = {};      
      for (r=3;r<dades.length;r++){
        var str = dades[r][c];
        if(itemsFound[str]) {
           continue; 
        }
        row.push(dades[r][c]);
        itemsFound[str] = true;
      }
      row.sort();      
      pas=true;

    } else if (dades[1][c].toLowerCase().indexOf("csvfiltre")>-1) {

      var row=[];
      var itemsFound = {};      
      for (r=3;r<dades.length;r++){
        var str = dades[r][c];
        var xF=str.split(",");
        for (f=0;f<xF.length;f++){
           if(itemsFound[xF[f]]) {
             continue; 
           }        
           row.push(xF[f]);
           itemsFound[xF[f]] = true;           
        }
      }
      row.sort();      
      pas=true;
    }
    
    if (pas==true){
      var nomCamp=dades[0][c];
      nomCamp=nomCamp.replace(new RegExp(' ', 'g'),'_');               
      nomCamp=nomCamp.replace(new RegExp('/', 'g'),'_');          
      flt +="<select class='selFiltre'  name='"+nomCamp+"' id='sel_"+nomCamp+"' onChange='aplicacioFiltres(this.id)'>";        
      flt +="<option value='*'>"+dades[0][c]+"</option>";              
      for (r=0;r<row.length;r++){
        var str=row[r];            
        str=str.replace(new RegExp(' ', 'g'),'_');
        str=str.replace(new RegExp('/', 'g'),'_');            
        if (str.length>0){            
            flt +="<option class='opcio' value="+str+">"+row[r]+"</option>";
        }
      }
      flt +="</select>";  
    }

     if (dades[1][c].toLowerCase().indexOf("agrupa")>-1) {
            numColAgrupa=c;
     }
     if (dades[1][c].toLowerCase().indexOf("colorpunt")>-1) {
            numColColorMark=c;
     }
     /*if (dades[1][c].toLowerCase().indexOf("iconamapa")>-1) {
            numColIconaMark=c;
     }   */  
     if (dades[1][c].toLowerCase().indexOf("nomllegendamapa")>-1) {
            numColNomLlegendaMapa=c;
     }
     /* eliminat perquè aquestà informació s'agafa ara de la configuració i per tant en la funció variables
     if (dades[1][c].toLowerCase().indexOf("latitud")>-1) {
            numColLatitud=c;
     }
     if (dades[1][c].toLowerCase().indexOf("longitud")>-1) {
            numColLongitud=c;
     } 
     //*/
     
     if (dades[1][c].toLowerCase().indexOf("id")>-1) {
            numColBotoProjecte=c;
     }   
     if (dades[1][c].toLowerCase().indexOf("dataini")>-1) {
            numColDataIni=c;
     }   
     if (dades[1][c].toLowerCase().indexOf("datafin")>-1) {
            numColDataFin=c;
     }        
     if (dades[1][c].toLowerCase().indexOf("descripcio")>-1) {
            numColDescripcio=c;
     }        
     if (dades[1][c].toLowerCase().indexOf("titol")>-1) {
            numColTitol=c;
     }        
     if (dades[1][c].toLowerCase().indexOf("bloc")>-1) {
            numColBloc=c;
     }        
     
     if(numColAgrupa<0) {
       numColAgrupa=numColLatitud;
     }
     
  }

  if (flt!="") {
     $("#divFiltres").css("visibility","visible"); 
     $('#divFiltres').html(flt);
  } else {
     $("#divFiltres").css("display","none");   
  }

  $('#selTipus').val(tipus);
}



//Aplicacio filtres
function aplicacioFiltres(id){
  //$("*").css("cursor","wait");
  if ($("#"+id).val()=="*") {
    $("#"+id).css("color","initial"); 
  } else {
    $("#"+id).css("color","red");
  }
 
  $('#botoCentrar').attr( "src", "https://drive.google.com/uc?id=1jVkYeRZiImemNB9QVHJjkbR2xaYgz4mz" );
 
  var finalArray=new Array();
  finalArray=row_org;

  filtresActius=0;
  for (c=0;c<finalArray[0].length; c++){
    if (finalArray[1][c].toLowerCase().indexOf("selfiltre")>-1 || finalArray[1][c].toLowerCase().indexOf("csvfiltre")>-1){
       var nomCamp=finalArray[0][c];
       nomCamp=nomCamp.replace(new RegExp(' ', 'g'),'_')
       nomCamp=nomCamp.replace(new RegExp('/', 'g'),'_') 
       //nomCamp=nomCamp.normalize('NFD').replace(/[\u0300-\u036f]/g, "_")
       if($("#sel_"+nomCamp).val()!="*"){
         filtresActius++;
         var arr=new Array();
         arr[0]=finalArray[0]
         arr[1]=finalArray[1]
         arr[2]=finalArray[2]         
         //for (r=Num_files;r<finalArray.length; r++){         
         var n=Num_files_capçalera
         for (r=Num_files_capçalera;r<finalArray.length; r++){                  
             var strName="[name='"+finalArray[r][Columna_id]+"#$"+finalArray[0][c]+"'";
             var strVal=$(strName).val();             
             var strCamp=finalArray[r][c];
             strCamp=strCamp.replace(new RegExp(' ', 'g'),'_')
             strCamp=strCamp.replace(new RegExp('/', 'g'),'_')             
             //strCamp=strCamp.normalize('NFD').replace(/[\u0300-\u036f]/g, "_")
             if (finalArray[1][c].toLowerCase().indexOf("selfiltre")>-1){
                if(strCamp==$("#sel_"+nomCamp).val()){             
                    arr[n]=finalArray[r];
                    n +=1;
                }
             } else if (finalArray[1][c].toLowerCase().indexOf("csvfiltre")>-1){
                if(strCamp.indexOf($("#sel_"+nomCamp).val())>-1){             
                    arr[n]=finalArray[r];
                    n +=1;
                }             
             }
         }
         finalArray=arr;
       }
    }
  }
  
  switch (tipus){
  case "mapa":
     creaMarcadors(finalArray);
     break;
  case "taula":
     creaTaula(finalArray);  
     break;
  case "targetes":
     creaTarges(finalArray);
     break;
  case "timemap":
     creaTimeMap(finalArray);
     break;     
  case "timeline":
     creaTimeLine(finalArray);
     break;       
  }
  //$("*").css("cursor","default");  
}


//Visualitza les primeres fitxes
function onDades(dad) {
   //console.log(dad)
   row_org=dad;
   creacioFiltres(row_org);
 
   $('#imgtemp').css('display','none');   
   aplicaTipus(tipus);   
}



//Visualitza les primeres fitxes
function creaTaula(row) {
  var dades=new Array();
  for (c=0;c<row[0].length; c++) {
    if (row[1][c].toLowerCase()=='id'){
      Columna_id=c;
      break;
    }
  }
  for (r=0; r<row.length; r++){
    var str="";   
    if (r>2){
      for (c=0; c<row[0].length;c++){
        if (row[2][c].length==0){
          str +="<div id='"+row[r][Columna_id]+"_"+row[0][c]+"'>"+row[r][c]+"</div>##";  
          //str +="<input disabled name='"+dades[r][Columna_id]+"#$"+dades[0][c]+"' value="+dades[r][c]+" style='width:100%'/>##";                    
        }      
        if (row[2][c].toLowerCase().indexOf("taula:visu")>-1){
          str +="<div id='"+row[r][Columna_id]+"_"+row[0][c]+"'>"+row[r][c]+"</div>##";  
          //str +="<input disabled name='"+dades[r][Columna_id]+"#$"+dades[0][c]+"' value="+dades[r][c]+" style='width:100%'/>##";          
        }
        if (row[2][c].toLowerCase().indexOf("taula:edit")>-1 && row[2][c].toLowerCase().indexOf("taula:areatext:edit")<0){ 
          if (row[r][c].length>0){ 
              var valor=row[r][c].replace(/[']+/g, '&apos;');
          }
          if (Permetre_edicio_taula=="S"){
              str +="<input id='"+row[r][Columna_id]+"_"+row[0][c]+"' name='"+row[r][Columna_id]+"#$"+row[0][c]+"' value='"+valor+"' style='width:100%'/>##";
          } else {
              str +="<div id='"+row[r][Columna_id]+"_"+row[0][c]+"'>"+row[r][c]+"</div>##";          
          }
        }      
        if (row[2][c].toLowerCase().indexOf("taula:areatext:edit")>-1){
          if (row[r][c].length>0){         
              var valor=row[r][c].replace(/[']+/g, '&apos;');        
          }
          if (Permetre_edicio_taula=="S"){
              str +="<textarea id='"+row[r][Columna_id]+"_"+row[0][c]+"' name='"+row[r][Columna_id]+"#$"+row[0][c]+"' style='width:100%'>"+valor+"</textarea>##";
          } else {
              str +="<div id='"+row[r][Columna_id]+"_"+row[0][c]+"'>"+row[r][c]+"</div>##";                 
          }          
        } 
        //if (row[2][c].toLowerCase().indexOf("boto")>-1 && row[2][c].toLowerCase()!="botoVisu"){
        if (row[2][c].toLowerCase().indexOf("taula:boto")>-1){        
          if (row[r][c].length>0 || row[1][c].toLowerCase()=="enllaç"){ 
             var name=row[r][c];        
             if (name.indexOf("'")>-1){             
                name=name.replace(/[']+/g, '&apos;');        
             }
             str +="<input type='button' id='btn_"+row[r][Columna_id]+"_"+c+"' name='"+name+"' onclick=\"fnBoto("+row[r][Columna_id]+","+c+",this.id, this.name);\" style='width:100%; height:25px; max-width: 150px;'value='"+row[0][c]+"'</input>##";
          } else {
             var name="";
             str +="<input type='button' id='btn_"+row[r][Columna_id]+"_"+c+"' style='background-color:grey; color:#FFFFFF;width: 100%; height: 25px; max-width: 150px; cursor: default;' disabled name='"+name+"' onclick=\"fnBoto("+row[r][Columna_id]+","+c+",this.id, this.name);\" style='width:100%; height:25px; max-width: 150px;'value='"+row[0][c]+"'</input>##";
          }
        }    
        if (row[2][c].toLowerCase().indexOf("taula:lupa")>-1){
           str +="<img src='https://drive.google.com/uc?id=1erUETb9i5H77tmsmbXQB-HgOqg2ZCwzq' id='btn_"+row[r][Columna_id]+"_"+c+"' onclick='obreDescripcio("+row[r][Columna_id]+");' style='width:25px' />##";
        }           
        if (row[2][c].toLowerCase().indexOf("taula:llapis")>-1){
           str +="<img src='https://drive.google.com/uc?id=1FvHayIHBYJDFNDVnBU0yWIXESzFLEil2' id='btn_"+row[r][Columna_id]+"_"+c+"' onclick='editaRegistre("+row[r][Columna_id]+");' style='width:25px' />##";
        }                   
        
        if (row[2][c].toLowerCase().indexOf("taula:radio:")>-1){
            if (Permetre_edicio_taula=="N"){
               var opc=row[2][c].substring(6,100);
               var opcions=opc.split(",");
               for (p=0;p<opcions.length;p++){
                  if (row[r][c]==opcions[p]){
                     str +="<input type='radio' id='"+row[r][Columna_id]+"_"+row[0][c]+"' checked value='"+opcions[p]+"' name='"+row[r][Columna_id]+"#$"+row[0][c]+"' id='"+row[r][Columna_id]+"#$"+row[0][c]+"' style='margin-left:5px'/>"+opcions[p];
                  } else {
                     str +="<input type='radio' id='"+row[r][Columna_id]+"_"+row[0][c]+"' value='"+opcions[p]+"' name='"+row[r][Columna_id]+"#$"+row[0][c]+"' style='margin-left:5px'/>"+opcions[p];
                  }
               }
               str +="##";               
             } else {
              str +="<div id='"+row[r][Columna_id]+"_"+row[0][c]+"'>"+row[r][c]+"</div>##";
            }
        }            
        if (row[2][c].toLowerCase().indexOf("taula:sel:")>-1){
            var opc=row[2][c].substring(4,100)
            var opcions=opc.split(",");
            var dsbl="";
            if (Permetre_edicio_taula=="S"){
               str +="<select id='"+row[r][Columna_id]+"_"+row[0][c]+"' name='"+row[r][Columna_id]+"#$"+row[0][c]+"' id='"+row[r][Columna_id]+"#$"+row[0][c]+"'>";          
               str +="<option value='*'>"+row[0][c]+"</option>";          
               for (p=0;p<opcions.length;p++){
                  if (row[r][c]==opcions[p]){
                     str +="<option selected value='"+opcions[p]+"'>"+opcions[p]+"</option>";
                  } else {
                     str +="<option value='"+opcions[p]+"'>"+opcions[p]+"</option>";
                  }
               }
               str +="</select>";
               str +="##";               
            } else {
              str +="<div id='"+row[r][Columna_id]+"_"+row[0][c]+"'>"+row[r][c]+"</div>##";                 
            }
        }         
      }
      str=str.substring(0,str.length-2);
      dades[r]=str.split("##");
    } else {
      dades[r]=row[r];             
    }
  }
  var txtDiv ="<form id='frmDades'>";  
      txtDiv +="<table id='tblDades' class='display' width='100%'></table>";
   txtDiv +="</form>";
   
  $("#divFormTaula").html(txtDiv);  
  comprovacioPermis();
  presentaDades(dades);  
}



//Actualització de les pàgines 
function presentaDades(dades) {
  $('#imgtemp').css("visibility","visible");  
   var targes=new Array();
   for (r=Num_files_capçalera;r<dades.length;r++){
      var str="";
      for (col=0;col<dades[0].length;col++){
          if (dades[2][col].length>0){ 
             str +=dades[r][col]+"##";
          }
      }
      str=str.substring(0,str.length-2);
      targes[r-3]=str.split("##");      
   }

   if ( $.fn.dataTable.isDataTable( '#tblDades' ) ) {
      $('#tblDades').unbind();      
      var dt1 = $.fn.dataTable.tables()[0];
      $(dt1).DataTable().destroy();
    }
   
   var titols=new Array();
   r=0;
   for (c=0;c<dades[0].length;c++){
      if (dades[2][c].length>0 && dades[2][c].toLowerCase().indexOf("taula")>-1){
        var title= dades[0][c];
        titols[r]={title};        
        r +=1;
      }
   }

  if (permisEdit=='S'){
      $("#btnPermis").show();    
      $("input").prop('disabled', false);     
      var paginacio=false;      
  } else {
      //$("#btnPermis").hide();    
      $("#btnPermis").prop('disabled', true);                     
      //var paginacio=true;      
      var paginacio=true;            
  }

   $('#tblDades').DataTable( {
        dom: 'Bfrtip',
        select: true,        
        buttons: ['csv','pdf','print'],
        data: targes,
        columns: titols,
        scrollY:        '50vh',
        scrollCollapse: true,
        paging: paginacio,        
        "order": []
        
    } );
    
  var table = $('#tblDades').DataTable();
     
  //$("#divBotons").css("visibility","visible");     
  $("#divTaula").show();  
  //$("#divBotons").show();   
  //$("*").css("cursor","default");  
  $('#imgtemp').css("display","none");    
}



//preparar parametres i enviar 
function activaInfo(){
   $("#modalHeader").html("Informació");
   var divMissatge=informacio;
   $("#missatge").html(divMissatge);
   $('#finestraInfo').modal('show');
   //$("*").css("cursor","default");   
}




//Visualitza les primeres fitxes
function editaRegistre(reg) {
  for (c=0;c<row_org[0].length; c++) {
    if (row_org[1][c].toLowerCase()=='id'){
      Columna_id=c;
      break;
    }
  }

  var msgTitol="Edició de les dades del registre: "+reg;

  var str="<form id='frmDadesReg'>";
      str +="<table id='tblEditReg' width='100%'>";
      str +="<tr><th style='width:10%'><label>Camp</label></th><th style='width:85%'><label>Valor</label></th>";
      
  for (r=0; r<row_org.length; r++){
    if (reg==row_org[r][Columna_id]) { 
       break;
    }
  }

  for (c=0; c<row_org[0].length;c++){
    if (row_org[2][c].length!=0){  
      str +="<tr><td><label>"+row_org[0][c]+": </label></td>";
      str +="<td>"
      if (row_org[2][c].toLowerCase().indexOf("text:visu")>-1 || row_org[2][c].toLowerCase().indexOf("areatext:visu")>-1){
        str +=row_org[r][c];
      }
      if (row_org[2][c].toLowerCase().indexOf("text:edit")>-1 && row_org[2][c].toLowerCase().indexOf("areatext:edit")<0){ 
        var valor=row_org[r][c];
        if (row_org[r][c].length>0){ 
           valor=row_org[r][c].replace(/[']+/g, '&apos;');
        }
        str +="<input name='"+row_org[r][Columna_id]+"#$"+row_org[0][c]+"' value='"+valor+"' style='width:100%'/>";
      }      
      if (row_org[2][c].toLowerCase().indexOf("areatext:edit")>-1){
        var valor=row_org[r][c]
        if (row_org[r][c].length>0){         
          valor=row_org[r][c].replace(/[']+/g, '&apos;');        
        }
        str +="<textarea name='"+row_org[r][Columna_id]+"#$"+row_org[0][c]+"' style='width:100%'>"+valor+"</textarea>";
      } 
      if (row_org[2][c].toLowerCase().indexOf("boto")>-1){        
        if (row_org[r][c].length>0 || row_org[0][c].toLowerCase()=="fitxa"){ 
          var name=row_org[r][c].replace(/[']+/g, '&apos;');        
          str +="<input type='button' id='btn_"+row_org[r][Columna_id]+"_"+c+"' name='"+name+"' onclick=\"fnBoto("+row_org[r][Columna_id]+","+c+",this.id, this.name);\" style='width:100%; height:25px; max-width: 150px;'value='"+row_org[0][c]+"'</input>";
        } else {
          var name="";
          str +="<input type='button' id='btn_"+row_org[r][Columna_id]+"_"+c+"' style='background-color:grey; color:#FFFFFF;width: 100%; height: 25px; max-width: 150px; cursor: default;' disabled name='"+name+"' onclick=\"fnBoto("+row_org[r][Columna_id]+","+c+",this.id, this.name);\" style='width:100%; height:25px; max-width: 150px;'value='"+row_org[0][c]+"'</input>";
        }
      }    
      if (row_org[2][c].toLowerCase().indexOf("lupa")>-1){
        str +="<img src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSwKGoUWN2ogT4KK7TvsB1krS76LLCkEkwUYG6p1znsATc__MhgYA' id='btn_"+row_org[r][Columna_id]+"_"+c+"' onclick='obreDescripcio("+row_org[r][Columna_id]+");' style='width:25px'/>";
      }           
      if (row_org[2][c].toLowerCase().indexOf("llapis")>-1){
        str +="<img src='https://www.shareicon.net/download/2016/07/03/636119_edit.ico' id='btn_"+row_org[r][Columna_id]+"_"+c+"' onclick='editaRegistre("+row_org[r][Columna_id]+");' style='width:25px'/>";
      }                   
          
      if (row_org[2][c].toLowerCase().indexOf("radio:")>-1){
        var opc=row_org[2][c].substring(6,100);
        var opcions=opc.split(",");
        for (p=0;p<opcions.length;p++){
          if (row_org[r][c]==opcions[p]){
            str +="<input type='radio' checked value='"+opcions[p]+"' name='"+row_org[r][Columna_id]+"#$"+row_org[0][c]+"' style='margin-left:5px'/>"+opcions[p];
          } else {
            str +="<input type='radio' value='"+opcions[p]+"' name='"+row_org[r][Columna_id]+"#$"+row_org[0][c]+"' style='margin-left:5px'/>"+opcions[p];
          }
        }
      }            
      if (row_org[2][c].toLowerCase().indexOf("sel:")>-1){
        var opc=row_org[2][c].substring(4,100)
        var opcions=opc.split(",");
        str +="<select name='"+row_org[r][Columna_id]+"#$"+row_org[0][c]+"'>";
        str +="<option value='*'>"+row_org[0][c]+"</option>";
        for (p=0;p<opcions.length;p++){
          if (row_org[r][c]==opcions[p]){
            str +="<option selected value='"+opcions[p]+"'>"+opcions[p]+"</option>";
          } else {
            str +="<option value='"+opcions[p]+"'>"+opcions[p]+"</option>";
          }
        }
        str +="</select>";
      }         
      str +="</td></tr>";
    }
  }
  str +="</table>";
  str +="</form>";

  var msgPeu="<div style='width:50%; float: left'>";
      if (permisEdit=="S"){
         msgPeu +="<input type='button' class='btn' aria-hidden='true' id='btnPermisEditReg' style='margin: 5px' onclick=\"enviarGenerarRegistre("+reg+")\" value='Enviar respostes'/>";
      } else {
         msgPeu +="<input type='button' class='btn' aria-hidden='true' id='btnPermisEditReg' style='margin: 5px' value='Enviar respostes'  onclick=\"missatgeError('No esteu autoritzat a guardar canvis')\" title='No esteu autoritzat a guardar canvis'/>"
      }
      msgPeu +='<button class="btn" data-dismiss="modal" aria-hidden="true" style="margin: 5px" >Tancar</button>';              
      msgPeu +="</div>";

  $('#modalHeaderTargetes').html(msgTitol);
  $('#missatgeTargetes').html(str);
  $('#missatgePeu').html(msgPeu);  
  $('*').css('cursor','default');    
  $('#finestraTargetes').modal('show');  
}


//preparar parametres i enviar 
function enviarGenerar(){
    //$("*").css("cursor","wait");
    var regArray = new Array();
    regArray=$("#frmDades").serializeArray();   
    //alert("1:\n"+regArray);
    var id=$("#idFullCalcul").val();
    var colconfig=$("#colconfig").val();   
    //google.script.run.withSuccessHandler(onSalvarDades).salvarDades(id,colconfig,regArray);         
    var valors=[id,colconfig,regArray];
    carregaDades('salvarDades',valors);         
}


function enviarGenerarRegistre(){
    //$("*").css("cursor","wait");
    var regArray = new Array();
    regArray=$("#frmDadesReg").serializeArray();   
    //console.log(regArray);    
    var id=$("#idFullCalcul").val();
    var colconfig=$("#colconfig").val();  
    //google.script.run.withSuccessHandler(onSalvarDades).salvarDades(id,colconfig,regArray);             
    var valors=[id,colconfig,regArray]    
    carregaDades('salvarDades',valors);                 
}


//preparar parametres i enviar 
function onSalvarDades(missatge){
   //console.log(missatge)
   $('#finestraTargetes').modal('hide');  
   $("#modalHeader").html(missatge[0]);
   
   //determinar columan de la matriu que te la ID   
   for (i=0;i<row_org[0].length;i++){           
      if (row_org[0][i].toLowerCase()=='id'){
         var columna_id=i;
         break;
      }
   }
   var divMissatge="";
      divMissatge +="<table id='tblResultats'>";   
      divMissatge +="<tr><th style='width: 10%; border: solid 1px grey'>Registre</th><th style='width: 10%; border: solid 1px grey'>Columna</th><th style='width: 30%;  border: solid 1px grey'>Valor antic</th><th style='width: 30%;  border: solid 1px grey'>Nou valor</th></tr>";   
      for (c=1; c<missatge.length; c++){
           //divMissatge +=missatge[c];
           divMissatge +="<tr><td style='border: 1px solid #cacaca !important; padding: 3px !important;'>"+missatge[c][0]+"</td><td style='border: 1px solid #cacaca !important; padding: 3px !important;'>"+missatge[c][3]+"</td><td style='border: 1px solid #cacaca !important; padding: 3px !important;'>"+missatge[c][4]+"</td><td style='border: 1px solid #cacaca !important; padding: 3px !important;'>"+missatge[c][5]+"</td></tr>";
           //modificar canvis en la taula             
           var div="#"+missatge[c][0]+"_"+missatge[c][3];
           $(div).html(missatge[c][5]);
           $(div).val(missatge[c][5]);           
           
           // determinar la columna a modificar
           for (x=0;x<row_org[0].length;x++){           
              if (row_org[0][x]==missatge[c][3]){                  
                 var colMod=x
                 break;
              }
           }

           //canviar les dades a la matriu
           for (r=0;r<row_org.length;r++){
               //console.log(row_org[r][columna_id]+"=="+missatge[c][0]);
               if (row_org[r][columna_id]==missatge[c][0]){
                   row_org[r][colMod]=missatge[c][5];
                   break;
               }
           }
      }
      divMissatge +="</table>";      
   $("#missatge").html(divMissatge);
   $('#finestraInfo').modal('show');
   //$("*").css("cursor","default");    
      
   $("#tblResultats").css({
     "border":"1px solid black",
     "width": "90%",
     "margin": "0 auto",  
     "max-height": "250px",
     "overflow-y": "scroll"});
}



function mostraErrades(missatge){
   $('#finestraTargetes').modal('hide');  
   $("#modalHeader").html(missatge[0][0]);
   var divMissatge="";
      divMissatge +="<table id='tblResultats'>";   
      divMissatge +="<tr><th style='width: 10%; border: solid 1px grey'>"+missatge[0][1]+"</th><th style='width: 10%; border: solid 1px grey'>"+missatge[0][2]+"</th><th style='width: 10%;  border: solid 1px grey'>"+missatge[0][3]+"</th></tr>";   
      for (c=1; c<missatge.length; c++){
         divMissatge +="<tr><td style='border: 1px solid #cacaca !important; padding: 3px !important;'>"+missatge[c][0]+"</td><td style='border: 1px solid #cacaca !important; padding: 3px !important;'>"+missatge[c][1]+"</td><td style='border: 1px solid #cacaca !important; padding: 3px !important;'>"+missatge[c][2]+"</td></tr>";           
      }
      divMissatge +="</table>";      
   $("#missatge").html(divMissatge);
   $('#finestraInfo').modal('show');
   //$("*").css("cursor","default");    
      
   $("#tblResultats").css({
     "border":"1px solid black",
     "width": "80%",
     "margin": "0 auto",  
     "max-height": "250px",
     "overflow-y": "scroll"});
}

//preparar parametres i enviar 
function missatgeError(missatge){
   $("#modalHeader").html("Avís");
   var divMissatge=missatge;
   $("#missatge").html(divMissatge);
   $('#finestraInfo').modal('show');
   //$("*").css("cursor","default");    
}




//Actualització de les pàgines 
function creaTarges(targes) {
  $('#imgtemp').css("visibility","visible");   

  divAmplada=$("#divPresTargetes").css("width");  
  divAmpladaTar=parseInt(divAmplada)/parseInt(Num_columnes);
  divAmpladaTar=divAmpladaTar-20; //afegir els marges laterals
  //nTarFila=(parseInt(parseInt(divAmplada)/divAmpladaTar));
  //alert("amplada contenidor: "+divAmplada+"\nNombre de columnes: "+Num_columnes+"\nAmplada targeta: "+divAmpladaTar+"\nNombre de targes per fila: "+nTarFila);
  
  divAmplada=$("#divPresTargetes").css("width");
  divAmpladaTar=parseInt(divAmplada)/parseInt(Num_columnes);
  divAmpladaTar=divAmpladaTar-20; //afegir els marges laterals
  //nTarFila=(parseInt(parseInt(divAmplada)/divAmpladaTar));
  //alert("amplada contenidor: "+divAmplada+"\nNombre de columnes: "+Num_columnes+"\nAmplada targeta: "+divAmpladaTar+"\nNombre de targes per fila: "+nTarFila);
  //var nReg=nTarFila*Num_files;
  var nReg=Num_columnes*Num_files;  
  
  if (numPag<1) {
     numPag=1
  };
  var xIni=Num_columnes*(numPag-1)*Num_files;
  var xFin=Num_columnes*(numPag)*Num_files;  

  if (xFin>targes.length-3) {
      numPag -=1;      
      xIni=Num_columnes*(numPag)*Num_files;
      xFin=targes.length-3;
  };    

    
  var divDades="<div style='clear:both; width: 100%;  right: 0;  left: 0; margin: auto;'>";  
  divDades +="<div class='row'>";    
   
  for (p=0;p<plantilles.length;p++){
     if (plantilles[p][0]=="targetes"){
       var plant=plantilles[p][2][0];
       break;
     }
  }
     
  var t=0;  
  for (var j = xIni+3; j < targes.length; j++) {  
     //console.log(j+"----"+targes.length);  
     var row_dad=targes[j];
     var plt=aplica_plantilla(plant,row_dad);
     divDades +=plt;
     t +=1;        
     var m=parseInt(t % Num_columnes);     
     if (m==0){
       divDades +="</div><div class='row'>";
     }          
    if (t>=nReg || t>=targes.length) {break};     
  }
  divDades +="</div>";
  divDades +="</div>";  

  if (xIni==0){
    $("#btnB1").css('background-color', '#CACACA');  
    $("#btnB1").css('color', '#FFFFFF');      
    $("#btnB1").prop('disabled', true);      
  } else {
    $("#btnB1").css('background-color', 'inherit');
    $("#btnB1").css('color', 'inherit');      
    $("#btnB1").prop('disabled', false);          
  }
  
  if (xFin>=parseInt(targes.length-3)){
    $("#btnB2").css('background-color', '#CACACA');    
    $("#btnB2").css('color', '#FFFFFF');          
    $("#btnB2").prop('disabled', true);          
  } else {
    $("#btnB2").css('background-color', 'inherit');
    $("#btnB2").css('color', 'inherit');          
    $("#btnB2").prop('disabled', false);          
  }


  if(xIni==0 && xFin>=parseInt(targes.length-3)){
    $("#btnNovaPagina").hide();
  } else {
    //$("#btnNovaPagina").css('visibility','visible');      
    $("#btnNovaPagina").show();             
  }

  var regPagina="Registres: "+(xIni+1)+" a  "+xFin+" de "+parseInt(targes.length-3);
  if(xIni==0 && xFin>=parseInt(targes.length-3)){
    $("#comptadorPagines").html(regPagina);    
    $("#comptadorPagines").hide();             
  } else {
    $("#comptadorPagines").html(regPagina);        
    $("#comptadorPagines").show();             
  }  
  

   
  $('#divPresTargetes').html(divDades);
  $(".targeta").css("width",divAmpladaTar);  
    
  $('#imgtemp').css("display","none");     
  //$("*").css("cursor","default");  
}



function creaMarcadors(finalArray){ // Construeix targes i mostra marcadors en el mapa
   var repetit=[];
   for (var i=0;i<finalArray.length;i++) {
     repetit[i]=false;
   }        
   var numCentres=0; 
   for(i=0;i<marcadors.length;i++) {
      if (Mostra_clusters=='S'){  
         markers.removeLayer(marcadors[i]);         
      } else {  
         map.removeLayer(marcadors[i]);
         oms.removeMarker(marcadors[i]);
      } 
   }   

   $('#imgtemp').css("display","none"); 
   if(Zoom_automatic=='N') {
     bounds=bounds_all;
     limitsMapa();     
   }
   centres=[];   
   agrupaCentres=[];
   marcadors=[]; 
   row_rep=[];  
   
   var numLlegendes=0;
         
// Agrupament de registres segons el criteri d'agrupament     
     
   for (var i=Num_files_capçalera;i<finalArray.length;i++) {
       if (!repetit[i]) {
         var repes=i+",";
         for(var j=i+1;j<finalArray.length;j++) {
            if (finalArray[j][numColLatitud].length>0 && finalArray[j][numColLongitud].length>0) {    
               var primer=finalArray[i][numColAgrupa];
               var segon=finalArray[j][numColAgrupa];
               if(primer==segon) {
                 repetit[j]=true;
                 repes +=j+",";
               }    
             }                
         }                                                  
         centres[numCentres]=[];
         for(var j=0;j<finalArray[0].length;j++) {
           centres[numCentres][j]=finalArray[i][j];
         }
         row_rep[numCentres]=repes;
         agrupaCentres[numCentres]=finalArray[i][numColAgrupa];      
         numCentres++;
       }  
   }
   
   if(numCentres==0) {
      missatgeError("No hi ha cap marcador en el mapa com a resultat dels filtres aplicats.");
   }
  
   var numSenseLloc=0;
   var stringSenseLloc="Relació de registres, segons el criteri d'agrupament, que no disposen de coordenades de localització vàlides <br> S'han situat a les coordenades 0,0 (equador/meridià 0)";
   var senseLloc=[];
   senseLloc[0]=[stringSenseLloc,finalArray[0][numColAgrupa],finalArray[0][numColLatitud],finalArray[0][numColLongitud]]
 
   //var locations=new Array();  
   var iColors=new Array(); 
   var titols=[];
   var llgd =""; //cadena on s'afegiran les icones de la llegenda per no repetir-les
   
   var white = { r: 255, g: 255, b: 255 };
   
// Agrupament de registres en marcadors i creació de les targeta dels marcadors   
   var contingutLlegenda="";
   var filaLlegenda=[];

   if (iniciantMapa) {
          arrayCheckboxesId=[];
          arrayCheckboxesValue=[];
          numCheckboxes=0;
          if(Mostra_poligons=='S') {
            checkboxPoligonsValue=true;
          } else {
            checkboxPoligonsValue=false;
          }
          if(Mostra_clusters=='S') {
            checkboxClustersValue=true;
          } else {
            checkboxClustersValue=false;
          }
          if(Mostra_densitat=='S') {
            checkboxHeatmapValue=true;
          } else {
            checkboxHeatmapValue=false;
          }
          checkboxMarcadorsValue=true;
   }
  
   //for (k=0;k<centres.length;k++) (function(i){  
   for (i=0;i<centres.length;i++) {
      var laLatitud=parseFloat(centres[i][numColLatitud]);
      var laLongitud=parseFloat(centres[i][numColLongitud]);

      var clr=Marcador_defecte_color;      
      if (numColColorMark!=""){
         if (centres[i][numColColorMark]!=""){
             var clr=centres[i][numColColorMark] //color del punt al mapa
         }
      }
      //console.log(centres[i][numColAgrupa]+"---"+laLatitud+"---"+laLongitud);
      if (laLatitud==0 || laLongitud==0 || isNaN(laLatitud) || isNaN(laLongitud) ) {
        laLatitud=0; //es posen a 0 per si el problema és que son NaN
        laLongitud=0;
        stringSenseLloc+=agrupaCentres[i]+"\n";
        numSenseLloc++;
        if (isNaN(agrupaCentres[i])){
            senseLloc[numSenseLloc]=[agrupaCentres[i].replace("@", "\@"),centres[i][numColLatitud],centres[i][numColLongitud]];
        } else {
            senseLloc[numSenseLloc]=[agrupaCentres[i],centres[i][numColLatitud],centres[i][numColLongitud]];        
        }
      } 
         
      locations[i]={lat: laLatitud, lng: laLongitud}; 
      iColors[i]=clr;
      titols[i]="";      
      if (numColTitol!=""){
          titols[i]=centres[i][numColTitol];
      }
      var row_dad=centres[i];
      var Capçalera=aplica_plantilla(plantilla_1,row_dad);
      
      //creació dels botons de cada registre agrupat
      var botons="";            
      var str=row_rep[i].substr(0,row_rep[i].length-1);
      var llistaReg=str.split(",");        
      for(var j=0;j<llistaReg.length;j++) { 
         var nId=llistaReg[j];
         var row_dad=finalArray[nId];
         var boto=aplica_plantilla(plantilla_2,row_dad);
         botons+=boto;
         botons+="<br>";
      }        
   
      Capçalera=Capçalera.replace("{{#Botons#}}",botons);                
      contentString='<div id="content">';               
      contentString+=Capçalera;
      contentString+='</div>';          

// Icones dels marcadors
    iconaDefinida=false;
      if(numColNomLlegendaMapa!=-1) {
        if(centres[i][numColNomLlegendaMapa]!="") { // Icona segons el tipus indicat
             
             var iniciSVG=llegendes.search("<"+centres[i][numColNomLlegendaMapa]+">")+centres[i][numColNomLlegendaMapa].length; // Inline SVG for HTML de https://materialdesignicons.com
             var finalSVG=llegendes.search("</"+centres[i][numColNomLlegendaMapa]+">");
             var cadenaSVG=llegendes.substring(iniciSVG,finalSVG); 
             
             var vertAnchor=pixelsIco*escalaIco/2;
             if (cadenaSVG.search("marcador")!=-1) {  // Si inclou la paraula "marcador"
                vertAnchor = pixelsIco*escalaIco;
             }
             
             var pos1=cadenaSVG.search("d=")+3;   
             var pos2=cadenaSVG.search(" />")-1;
             var path=cadenaSVG.substring(pos1,pos2); 
             
             if (path.length<3) { // Si no es troba la definició a la plantilla
               if(Marcador_defecte_forma!="") { // Si s'ha indicat el marcador per defecte
             
                 iniciSVG=llegendes.search("<"+Marcador_defecte_forma+">")+Marcador_defecte_forma.length;
                 finalSVG=llegendes.search("</"+Marcador_defecte_forma+">");
                 cadenaSVG=llegendes.substring(iniciSVG,finalSVG);
                 
                 var vertAnchor=pixelsIco*escalaIco/2;
                 if (cadenaSVG.search("marcador")!=-1) {
                    vertAnchor= pixelsIco*escalaIco;
                 }
                              
                 var pos1=cadenaSVG.search("d=")+3;   
                 var pos2=cadenaSVG.search(" />")-1;
                 var path =cadenaSVG.substring(pos1,pos2);
                 
                 if (path.length<3) { // Si s'ha indicat marcador per defecte però no es troba la definició a la plantilla
                   path=path_defecte;                           
                   vertAnchor = pixelsIco*escalaIco;
                 }                                  
               } else { // Si no s'ha indicat marcador per defecte      */            
                 path=path_defecte;                           
                 vertAnchor = pixelsIco*escalaIco;
               }
           }
             
             
             
             cadenaSVG='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+pixelsIco+' '+pixelsIco+'"><path d="'+path+'" fill="'+iColors[i]+'" /></svg>';
             
             var myIconUrl = encodeURI("data:image/svg+xml," + cadenaSVG).replace('#','%23');             
             var icon = L.icon( {
                  iconUrl: myIconUrl,
                  iconSize: [pixelsIco*escalaIco, pixelsIco*escalaIco],
                  iconAnchor: [pixelsIco*escalaIco/2, vertAnchor]
             } );

             var iconaLlegenda ="<input type='checkbox' checked id='ico_"+centres[i][numColNomLlegendaMapa]+"' value='"+centres[i][numColNomLlegendaMapa]+"' style=\"vertical-align:-3px\" onchange=\"desactivaCapa('ico_"+centres[i][numColNomLlegendaMapa]+"')\"/><svg style='height:24px; width:24px; vertical-align:-4px'><path fill='"+iColors[i]+"' d='"+path+"' stroke='black' stroke-width='0' /></svg>"; 
             
             iconaDefinida=true;                
        }
      }
      
      if (!iconaDefinida) {
        if(Marcador_defecte_forma!="") { // Icona per defecte definida per l'usuari 
                     
             var iniciSVG=llegendes.search("<"+Marcador_defecte_forma+">")+Marcador_defecte_forma.length; // Inline SVG for HTML de https://materialdesignicons.com
             var finalSVG=llegendes.search("</"+Marcador_defecte_forma+">");
             var cadenaSVG=llegendes.substring(iniciSVG,finalSVG);
             
             var vertAnchor=pixelsIco*escalaIco/2;
             if (cadenaSVG.search("marcador")!=-1) {
                vertAnchor= pixelsIco*escalaIco;
             }
                          
             var pos1=cadenaSVG.search("d=")+3;   
             var pos2=cadenaSVG.search(" />")-1;
             var path =cadenaSVG.substring(pos1,pos2); 
             
             cadenaSVG='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+pixelsIco+' '+pixelsIco+'"><path d="'+path+'" fill="'+iColors[i]+'" /></svg>';
             
             var myIconUrl = encodeURI("data:image/svg+xml," + cadenaSVG).replace('#','%23');             
             var icon = L.icon( {
                  iconUrl: myIconUrl,
                  iconSize: [pixelsIco*escalaIco, pixelsIco*escalaIco],
                  iconAnchor: [pixelsIco*escalaIco/2, vertAnchor]
             } );
                 
             var iconaLlegenda ="<input type='checkbox' checked id='ico_"+centres[i][numColNomLlegendaMapa]+"' value='"+centres[i][numColNomLlegendaMapa]+"' style=\"vertical-align:-3px\" onchange=\"desactivaCapa('ico_"+centres[i][numColNomLlegendaMapa]+"')\"/><svg style='height:24px; width:24px; vertical-align:-4px'><path fill='"+iColors[i]+"' d='"+path+"' stroke='black' stroke-width='0' /></svg>";
                          
             if(numColNomLlegendaMapa!=-1) { // Per tal que mostri el marcador per defecte definit per l'usuari en la llegenda
               centres[i][numColNomLlegendaMapa]=Marcador_defecte_forma;
             } 
             
        } else {  // Definició de la icona per defecte dels marcadors  
             cadenaSVG='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+pixelsIco+' '+pixelsIco+'"><path d="'+path_defecte+'" fill="'+iColors[i]+'" /></svg>';
             var myIconUrl = encodeURI("data:image/svg+xml," + cadenaSVG).replace('#','%23');             
             var icon = L.icon( {
                  iconUrl: myIconUrl,
                  iconSize: [pixelsIco*escalaIco, pixelsIco*escalaIco],
                  iconAnchor: [pixelsIco*escalaIco/2, pixelsIco*escalaIco]
             } );
        }        
      }      
      
      marcadors[i]=L.marker(locations[i],{icon:icon});
      marcadors[i].bindPopup(contentString);
          
      if (Mostra_clusters=='S'){  
         markers.addLayer(marcadors[i]);         
      } else {  
         marcadors[i].addTo(map);
         oms.addMarker(marcadors[i]);
      }

      //construcció dels elements de la llegenda si té posició       
      
      if (Posicio_llegenda.toLowerCase()!="sense_llegenda"){
        if (numColNomLlegendaMapa!=-1){
           if (llgd.indexOf(centres[i][numColNomLlegendaMapa])==-1){
              llgd +="#$#"+centres[i][numColNomLlegendaMapa];
              filaLlegenda[numLlegendes]="<div style='width:150px; margin: 5px; vertical-align:middle; horizontal-align:left'>"+iconaLlegenda+centres[i][numColNomLlegendaMapa]+"</div>";
              numLlegendes++;
              // Array Checkboxes
              if (iniciantMapa) {
                 arrayCheckboxesId[numCheckboxes]=centres[i][numColNomLlegendaMapa];
                 arrayCheckboxesValue[numCheckboxes]=true;
                 numCheckboxes++;
              }
           }
        }        
      }      
   }//)(k);      
   
   map.addLayer(markers);
   
        if(numLlegendes==0) {
             cadenaSVG='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+pixelsIco+' '+pixelsIco+'"><path d="'+path_defecte+'" fill="'+Marcador_defecte_color+'" /></svg>';
             //console.log(cadenaSVG);
             var myIconUrl = encodeURI("data:image/svg+xml," + cadenaSVG).replace('#','%23');             
             var icon = L.icon( {
                  iconUrl: myIconUrl,
                  iconSize: [pixelsIco*escalaIco, pixelsIco*escalaIco],
                  iconAnchor: [pixelsIco*escalaIco/2, pixelsIco*escalaIco]
             } );
             var iconaLlegenda ="<input type='checkbox' checked id='marcadors' value='Marcadors' style=\"vertical-align:-3px\" onchange=\"desactivaCapa('marcadors')\"/><svg style='height:24px; width:24px; vertical-align:-4px'><path fill='"+Marcador_defecte_color+"' d='"+path_defecte+"' stroke='black' stroke-width='0' /></svg>";         
             numLlegendes=1;
             filaLlegenda[0]="<div style='width:150px; margin: 5px; vertical-align:middle; horizontal-align:left'>"+iconaLlegenda+"Marcadors</div>";                
        }   
   
   filaLlegenda.sort(function (a,b){
       return naturalSort(a,b);
   });   
   
   for(i=0;i<numLlegendes;i++){   
      contingutLlegenda+=filaLlegenda[i];
   }
   
   if(Casella_poligons=='S'||Casella_clusters=='S'||Casella_densitat=='S') {
     contingutLlegenda+="<hr/>";
   }
   
  //poligons
  
    if(row_poligons!=null) {
      if (row_poligons.length>3){
        if(iniciantMapa) {
            for (c=0; c<row_poligons[1].length;c++){
                switch (row_poligons[1][c].toLowerCase()){
                case "id":
                    var colId=c;
                    break;
                case "nompoligon":
                    var colNom=c;
                    break;    
                case "poligon":
                    var colGeo=c;
                    break;      
                case "colorpoligon":
                    var colColPol=c;
                    break;                  
                }
            }
            var nom=[];
            var geo=[];
            for (p=3;p<row_poligons.length;p++){
              /*
               var pas=false;

               var item =row_poligons[p][colGeo];
               if (typeof item !== "string"){
                  JSON.stringify(item);
               }

               try {
                  item = JSON.parse(item);
               } catch (e) {
                  console.log(item)               
                  pas=false;
               }
 
               if (typeof item === "object" && item !== null) {

                   pas=true;
               }
               console.log(pas)               
               console.log(typeof item)               
               //*/
               
               //if (pas==true){
               if (row_poligons[p][colGeo]!==null){
                  nom[p]=row_poligons[p][colNom];
                  geo[p]=eval(row_poligons[p][colGeo]);

                  var color=row_poligons[p][colColPol]
                  if (color==""){         
                     color=getRandomColor();
                  }
                  poligons[p] = L.polygon(geo[p], {
                     fillOpacity: 0.5,
                     color: color,
                     strokeWidth: 2,
                     strokeOpacity: 0.8
                  });
                  if(checkboxPoligonsValue) {
                    poligons[p].addTo(map); 
                  }
               } 
            }
          }
          //if (llgd.indexOf("Poligons")==-1){
          llgd +="#$#Polígons";    
          path="M17,15.7V13H19V17L10,21L3,14L7,5H11V7H8.3L5.4,13.6L10.4,18.6L17,15.7M22,5V7H19V10H17V7H14V5H17V2H19V5H22Z";
          var iconaLlegenda ="<svg style='height:24px; width:24px; vertical-align:-4px'><path fill='#CC00CC' d='"+path+"' stroke='black' stroke-width='0' /></svg>"; 
          if (Casella_poligons=='S') {
            contingutLlegenda+="<div style='width:150px; margin: 5px; vertical-align:middle; horizontal-align:left'><input type='checkbox' id='poligons' style='vertical-align:-3px' onchange=\"desactivaCapa(this.id)\"/>"+iconaLlegenda+"Polígons</div>";               
          }
       }
    } 
    
    llgd +="#$#Clusters";    
    path="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z";
    var iconaLlegenda ="<svg style='height:24px; width:24px; vertical-align:-4px'><path fill='#00FF00' d='"+path+"' stroke='black' stroke-width='0' /></svg>"; 
    if (Casella_clusters=='S') {
      contingutLlegenda+="<div style='width:150px; margin: 5px; vertical-align:middle; horizontal-align:left'><input type='checkbox' id='clusters' style='vertical-align:-3px' onchange=\"desactivaClusters(this.id)\"/>"+iconaLlegenda+"Clusters</div>";    
    }
    
    llgd +="#$#heatmap";    
    path="M11.71,19C9.93,19 8.5,17.59 8.5,15.86C8.5,14.24 9.53,13.1 11.3,12.74C13.07,12.38 14.9,11.53 15.92,10.16C16.31,11.45 16.5,12.81 16.5,14.2C16.5,16.84 14.36,19 11.71,19M13.5,0.67C13.5,0.67 14.24,3.32 14.24,5.47C14.24,7.53 12.89,9.2 10.83,9.2C8.76,9.2 7.2,7.53 7.2,5.47L7.23,5.1C5.21,7.5 4,10.61 4,14A8,8 0 0,0 12,22A8,8 0 0,0 20,14C20,8.6 17.41,3.8 13.5,0.67Z";
    var iconaLlegenda ="<svg style='height:24px; width:24px; vertical-align:-4px'><path fill='#FF0000' d='"+path+"' stroke='black' stroke-width='0' /></svg>"; 
    if (Casella_densitat=='S') {
      contingutLlegenda+="<div style='width:150px; margin: 5px; vertical-align:middle; horizontal-align:left'><input type='checkbox' id='heatmap' style='vertical-align:-3px' onchange=\"desactivaHeatMap(this.id)\"/>"+iconaLlegenda+"Densitat</div>";    
    }
                            
//construcció de la llegenda si té posició 
 if (Posicio_llegenda.toLowerCase()!="sense_llegenda" && contingutLlegenda!=""){    
          var pos_lle=[["dalt_esquerra","topleft"],["dalt_centre","topright"],["dalt_dreta","topleft"],["esquerra_dalt","topleft"],["esquerra_centre","bottomleft"],["esquerra_baix","bottomleft"],["baix_esquerra","bottomleft"],["dreta_dalt","topleft"],["dreta_centre","bottomright"],["dreta_baix","bottomright"],["baix_centre","bottomright"],["baix_dreta","bottomright"]];
          for (g=0;g<pos_lle.length;g++){
               if(pos_lle[g][0]==Posicio_llegenda){
                  posicio=pos_lle[g][1];         
               }
          }      
          var legend = L.control({position: posicio});
          legend.onAdd = function (map) { 
              map.legend = this;
              var div = L.DomUtil.create('div', 'laLlegenda'); 
              div.innerHTML= contingutLlegenda;              
              // Disable dragging when user's cursor enters the element
              div.addEventListener('mouseover', function () {
              map.dragging.disable();
              });              
              // Re-enable dragging when user's cursor leaves the element
              div.addEventListener('mouseout', function () {
              map.dragging.enable();
              });
              return div;
          }; 

       if (iniciantMapa) {
           legend.addTo(map); 
           $(".laLlegenda").attr('id', 'llegendaMapa');           
       } else {
           $("#llegendaMapa").html(contingutLlegenda);
       }            
  } 

  
// Visualització d'errades o omissió de dades de latitud i longitud
   if(numSenseLloc>0){
       if (Visualitzar_errors=="S") {
         mostraErrades(senseLloc);
       }
   }
      
// Determinació dels límits del mapa 
   if (marcadors.length>0) {
     bounds=L.latLngBounds(marcadors[0].getLatLng(), marcadors[0].getLatLng());
     for (var l = 0; l < marcadors.length; l++) {
        bounds.extend(marcadors[l].getLatLng());
     } 
      
     // Determinació dels límits del mapa inicial      
     if (iniciantMapa) {  
        iniciantMapa=false;
        bounds_all=bounds;
        var $mapDiv = $('#map');
        var mapDim = { height: $mapDiv.height(), width: $mapDiv.width() };
        map.fitBounds(bounds);
        var zoomMapa=map.getZoom();
        var centreMapa=bounds.getCenter();

        // Recull de variables relacionades amb el mapa inicial
        if (Centre_mapa!='A') {
           var cadenaCentre=Centre_mapa.split(',');
           var latInicial=parseFloat(cadenaCentre[0]);
           var lonInicial=parseFloat(cadenaCentre[1]);
        }
        var zoomInicial=parseFloat(Zoom_inicial);
    
        // Tipus de mapa inicial
  
        if (zoomInicial==0 && Centre_mapa=='A') { // tot automàtic
           iniciantMapa=false;
        }
        if (zoomInicial>0 && Centre_mapa=='A') { // centre automàtic
           map.setZoom(zoomInicial);
           map.panTo(centreMapa);
        }
        if (zoomInicial==0 && Centre_mapa!='A') { // zoom automàtic
           map.setZoom(zoomMapa);
           map.panTo(new L.LatLng(latInicial, lonInicial));
        }
        if (zoomInicial>0 && Centre_mapa!='A') { // tot manual
           map.setZoom(zoomInicial);
           map.panTo(new L.LatLng(latInicial, lonInicial));
        }
     } 
   }    

   // Si no hi ha filtres actius, mostra el mapa inicial
   if (filtresActius>0) {
     if (Zoom_automatic=='S') {
         limitsMapa();
     }         
   } else {
   if (!iniciantMapa) {
     bounds=bounds_all;
     limitsMapa();
     }
   }
   
   // Situar la llegenda al mapa
   if (Posicio_llegenda.toLowerCase()!="sense_llegenda"){
      $("#llegendaMapa").css("visibility","visible");                    
      $("#llegendaMapa").css("display","block");     
   }
   
   // Mapa de densitat   
   creaHeatMap();     
   
   // Recordar estat checkboxes
   for(k=0;k<numCheckboxes;k++) {
      var mrk="ico_"+arrayCheckboxesId[k];
      $("[id='"+mrk+"']").prop("checked",arrayCheckboxesValue[k]);
      mostraCapa(mrk);
   }
   $("[id='poligons']").prop("checked",checkboxPoligonsValue);
   $("[id='clusters']").prop("checked",checkboxClustersValue);
   $("[id='heatmap']").prop("checked",checkboxHeatmapValue);
   $("[id='marcadors']").prop("checked",checkboxMarcadorsValue);
   
   // Tancament de la finestra d'espera   
   $('#imgtemp').css("display","none");           
   //$("*").css("cursor","default");     
  
   if (Mostra_densitat=='S') {
     map.addLayer(heat);
     desactivaMarcadors();
   }
}

function desactivaCapa(ico){
    if (ico=="poligons"){
        checkboxPoligonsValue=!checkboxPoligonsValue;
    } else {
         if (ico=="marcadors"){
            checkboxMarcadorsValue=!checkboxMarcadorsValue; 
         } else {
                    var iconaEscollida=0;
                    for(j=0;j<numCheckboxes;j++) { 
                        if("ico_"+arrayCheckboxesId[j]==ico) { 
                            iconaEscollida=j; 
                        }
                    }
                    arrayCheckboxesValue[iconaEscollida]=!arrayCheckboxesValue[iconaEscollida];
                 }
    } 
    mostraCapa(ico);
}

function desactivaClusters(ico){
    if($("#clusters").is(":checked")){
        checkboxClustersValue=true;
        Mostra_clusters='S';
        
        for(i=0;i<marcadors.length;i++) {
          map.removeLayer(marcadors[i]);
          oms.removeMarker(marcadors[i]);             
        }     
                
        for (var i = 0; i < marcadors.length; i++) {
          var mrk="ico_"+centres[i][numColNomLlegendaMapa];      
          if ($("[id='"+mrk+"']").is(":checked")) {  
              markers.addLayer(marcadors[i]);      
          } else { 
              markers.removeLayer(marcadors[i]);       
          }
        }

    } else {
        checkboxClustersValue=false;
        Mostra_clusters='N';  
        for (var i = 0; i < marcadors.length; i++) {
            markers.removeLayer(marcadors[i]);
        }  
        oms = new OverlappingMarkerSpiderfier(map,{nearbyDistance:1});
        oms.addListener('spiderfy', function(markers) {
        map.closePopup();
        });
        for (var i = 0; i < marcadors.length; i++) {        
            marcadors[i].addTo(map);
            oms.addMarker(marcadors[i]);
        }
    }
}

function activaMarcadors() {
      for (var i = 0; i < marcadors.length; i++) {
      var mrk="ico_"+centres[i][numColNomLlegendaMapa];
      
         if ($("[id='"+mrk+"']").is(":checked")) {
             if (Mostra_clusters=='S'){  
                markers.addLayer(marcadors[i]);         
             } else {  
                marcadors[i].addTo(map);
                oms.addMarker(marcadors[i]);
             } 
        } else {
             if (Mostra_clusters=='S'){  
                markers.removeLayer(marcadors[i]);         
             } else {  
                map.removeLayer(marcadors[i]);
                oms.removeMarker(marcadors[i]);
             }           
      }
    }
}

function desactivaMarcadors() {
      for (var i = 0; i < marcadors.length; i++) {
             if (Mostra_clusters=='S'){  
                markers.removeLayer(marcadors[i]);         
             } else {  
                map.removeLayer(marcadors[i]);
                oms.removeMarker(marcadors[i]);
             } 
        }
}

function creaHeatMap() {
    heat = L.heatLayer(locations,{
            radius: 15,
            blur: 15, 
            maxZoom: 10,
            max: 0.4,
            gradient: {
                        0.0: 'blueviolet',
                        0.1: 'deepskyblue',
                        0.2: 'dodgerblue',
                        0.3: 'aquamarine',
                        0.4: 'green',
                        0.5: 'lime',
                        0.6: 'yellow',
                        0.7: 'lightcoral',
                        0.8: 'orange',
                        0.9: 'orangered',
                        1.0: 'red',
                    }
            });
}

function desactivaHeatMap(ico){
  if($("#heatmap").is(":checked")){
    checkboxHeatmapValue=true;
    Mostra_densitat='S';    
    map.addLayer(heat);
    desactivaMarcadors();

  } else {
    checkboxHeatmapValue=false;
    Mostra_densitat='N';
    map.removeLayer(heat);
    activaMarcadors();
  }  
}

function mostraCapa(ico) {
   if (ico!="poligons"){
      for (var i = 0; i < marcadors.length; i++) {
        if (ico=="marcadors") {
             var mrk=ico;
        } else {
             var mrk="ico_"+centres[i][numColNomLlegendaMapa];
        }        
        
        if (mrk==ico){
           if ($("[id='"+mrk+"']").is(":checked")) {
               if (Mostra_clusters=='S'){  
                  markers.addLayer(marcadors[i]);         
               } else {  
                  marcadors[i].addTo(map);
                  oms.addMarker(marcadors[i]);
               } 
          } else {
               if (Mostra_clusters=='S'){  
                  markers.removeLayer(marcadors[i]);         
               } else {  
                  map.removeLayer(marcadors[i]);
                  oms.removeMarker(marcadors[i]);
               } 
          }  
        }
      }        
  } else {     
    for (var i = 3; i < poligons.length; i++) {
      if($("#poligons").is(":checked")){
           poligons[i].addTo(map);    
      } else {
           poligons[i].remove();
      }
    }
  }
}

function limitsMapa(){  // Actualitza el mapa segons els límits establerts
    if (marcadors.length>0) {     
      map.fitBounds(bounds);
      if(map.getZoom()>Zoom_max) {
         map.setZoom(Zoom_max);
      }
    }  
}

function centrar(){  // Actualitza el mapa segons els filtres actius en mode zoom manual 
  if (filtresActius>0) {
    $('#botoCentrar').attr( "src", "https://drive.google.com/uc?id=1bJRPWpX5MjnYXB8EW65TBHXLXbSMdYYZ" );  
  }
  limitsMapa();
}

function aplica_plantilla(plantilla,row_dad,row_cap){

  if (row_dad==undefined){
    alert("No hi ha dades al registre");
    return;
  }
  if (typeof(row_cap)=="undefined"){
     var row_cap=[];
     row_cap[0]=row_org[0];
     row_cap[1]=row_org[1];
  }
  for (c=0;c<row_cap[0].length; c++){
    if (plantilla.indexOf("{{"+row_cap[0][c]+"}}")>-1){
      var cadena="{{"+row_cap[0][c]+"}}";
      if (row_cap[1][c].toLowerCase().indexOf("datahora")>-1){  
         var date = new Date(row_dad[c]*1000);
         var dia = date.getDate();
         var mes = date.getMonth();
         var any = date.getFullYear();         
         var hours = date.getHours();
         var minutes = "0" + date.getMinutes();
         var seconds = "0" + date.getSeconds();
         var formattedTime = dia + '/' + mes + '/' + any;
         //var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);         
         var valSubs=date;
      } else if (row_cap[1][c].toLowerCase().indexOf("carousel")>-1){  
         var atzar=Math.floor((Math.random() * 10000) + 1);
         var valSubs=carousel(row_cap[0][c]+"_"+atzar,row_dad[c]);
      } else if (row_cap[1][c].toLowerCase().indexOf("iframe")>-1) {
         var valSubs="<iframe class='iframe' src='"+row_dad[c]+"'></iframe>";
      } else {
         var valSubs=row_dad[c];          
      }

      plantilla=plantilla.replace(new RegExp(cadena, 'g'), valSubs); 

      $("#ocult").html(plantilla);
      $("#ocult a[href='']").attr("class","nourl");
      $("#ocult img[src='']").attr("class","nologo");      
      
      plantilla=$("#ocult").html();
    }
  }     
  return plantilla;
}


function carousel(nomCar,imgCar){
  var row_car=imgCar.split(",");
  //<!-- Indicators -->
  var strCar="<div id='"+nomCar+"' class='carousel slide' data-ride='carousel'>";
    strCar +="<ol class='carousel-indicators'>";
    for (c=0;c<row_car.length;c++){
      if (c==0){      
        strCar +="<li data-target='#"+nomCar+"' data-slide-to='"+c+"' class='active'></li>";
      } else {
        strCar +="<li data-target='#"+nomCar+"' data-slide-to='"+c+"'></li>";
      }
    }
    strCar +="</ol>";

    //<!-- Wrapper for slides -->
    strCar +="<div class='carousel-inner'>";
        for (c=0;c<row_car.length;c++){      
          if (c==0){
            strCar +="<div class='item active'>";
               strCar +="<img src='"+row_car[c]+"'/>";
            strCar +="</div>";           
          } else {
            strCar +="<div class='item'>";           
               strCar +="<img src='"+row_car[c]+"'/>";
            strCar +="</div>";           
          }

        }
    strCar +="</div>";

    //<!-- Left and right controls -->
    strCar +="<a class='left carousel-control' href='#"+nomCar+"' data-slide='prev'>";
      strCar +="<span class='glyphicon glyphicon-chevron-left'></span>";
      strCar +="<span class='sr-only'>Previous</span>";
    strCar +="</a>";
    strCar +="<a class='right carousel-control' href='#"+nomCar+"' data-slide='next'>";
      strCar +="<span class='glyphicon glyphicon-chevron-right'></span>";
      strCar +="<span class='sr-only'>Next</span>";
    strCar +="</a>";
  strCar +="</div>";
  
  //console.log(strCar);

   return strCar;
}



//HistoryMap

function obreHistoria(pestanya,nomColCerca,valCerca){
  //$('*').css('cursor','wait');
  $('#imgtemp').css('display','block');
  $('#imgtemp').css("visibility","visible");  
  //valCerca=valCerca.replace(new RegExp("′", 'g'),"'"); 
  var id=$("#idFullCalcul").val();
  var colconfig=$("#colconfig").val();      
  var fltr=$("#fltr").val();   
  //google.script.run.withSuccessHandler(onHistoryMap).recollidaDadesSub(pestanya,nomColCerca,valCerca,id,colconfig);
  var valors=[pestanya,nomColCerca,valCerca,id,colconfig];
  //carregaDades('withSuccessHandler',valors);  
  carregaDades('obreHistoria',valors);   
}





function onHistoryMap(row_sub){
  console.log(row_sub);
  if (row_sub.length<4){
    alert("No hi ha dades a representar d'aquest fet.")
    return;
  }

  var mpas=false;
  var historia=''; //informació de la columna lateral dreta
  var titolFinestra="<h3 style='text-align:center'>Mapa del recurregut històric de: "+row_sub[3][2]+"</h3>";  
  var coord="[";
  for (i=3;i<row_sub.length;i++){
    coord +="["+row_sub[i][7]+","+row_sub[i][8]+"],";
    if (mpas==false){
      mpas=true;
      historia +="<h3>"+row_sub[i][2]+"</h3>";
      historia +="<img src='"+row_sub[i][9]+"' style='height:300px;border: 1px solid grey; display: block; margin: 0px auto; box-shadow: 10px 15px #ab9680'>"; 
    }
    historia +="<div style='margin-top:20px'>"+row_sub[i][6]+"</div>";   
  };

  if( coord.length>2){
     coord=coord.substr(0,coord.length-1);     
  }
  coord +="]";
  var coordenades=JSON.parse(coord);

  //console.log(coordenades.length);

  if(map2!=undefined) {
    map2.remove();
  }

  map2 = L.map('leaflet', {
  });

  proveidor=L.gridLayer.googleMutant({ type: 'roadmap' }).addTo(map);         
  map2.addLayer(proveidor); 

  //afegir ruta
  var polyline = new L.Polyline(
  coordenades, 
  {
    color: 'green',
    weight: 3,
    opacity: 0.5
  }).addTo(map2);

  $('#historyMap').on('shown.bs.modal', function(){
    setTimeout(function() {
      map2.invalidateSize();              
      if (coordenades.length>0){
        map2.fitBounds(polyline.getBounds());
      }
    }, 2);
   });


  //afegir punts
  var icon = L.icon({
    iconUrl: 'http://blocs.xtec.cat/llambordes/files/2018/09/triangleBlauS.png',
    //shadowUrl: 'leaf-shadow.png',
    iconSize:     [34, 45], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [17, 45], // point of the icon which will correspond to marker's location
    //shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
  });

  $('#historyMap').on('shown.bs.modal', function(){
    setTimeout(function() {
         for (c=0;c<coordenades.length;c++){
         //*
        var divHis ="<div style='padding: 0px 5%'>";
              divHis +="<div><h4>Esdeveniment: </h4></div>";                
              divHis +="<div><strong>"+row_sub[c+3][5]+"</strong></div>";        
              divHis +="<img src='"+row_sub[c+3][9]+"' style='width:75px;'>";
              divHis +="<div style='margin-top:20px'>"+row_sub[c+3][6]+"</div>";
              divHis +="<div>Data inici: "+row_sub[c+3][3]+"</div>";            
            divHis +="</div>";
         /*/
         //var plan="<div style='padding: 0px 5%'><div><h4>Esdeveniment:</h4></div><div><strong>{{Persona}}</strong></div><img src='{{Imatge}}' style='width:75px;'><div style='margin-top:20px'>{{Descripcio}}</div><div>Data inici: {{Datainici}}</div></div>";
         var plan="<div style='padding: 0px 5%'><div><h4>Esdeveniment: </h4></div><div><strong>Naixement</strong></div><img src='http://blocs.xtec.cat/llambordes/files/2018/09/triangleBlauS.png' style='width:75px;'><div style='margin-top:20px'>Va nèixer a Alcalá de la Selva (Terol) el 14 de juliol de 1900</div><div>Data inici: 14/07/1900</div></div>";
         var divHis=aplica_plantilla(plan,row_sub[c+3],row_sub);         
         var divHis="<div style='padding: 0px 5%'><div><h4>Esdeveniment: </h4></div><div><strong>Naixement</strong></div><img src='http://blocs.xtec.cat/llambordes/files/2018/09/triangleBlauS.png' style='width:75px;'><div style='margin-top:20px'>Va nèixer a Alcalá de la Selva (Terol) el 14 de juliol de 1900</div><div>Data inici: 14/07/1900</div></div>";
         //*/
         //console.log(divHis);                  
        //setTimeout(function() {            
          marker[c]=L.marker(coordenades[c],{icon:icon},{title:"marker_3"}).addTo(map2);
          marker[c].bindPopup(divHis); //si es vol obert .openPopup()    

        //},500);
      }
    }, 2);
  });
  //final afegir punts

  //obrir la targeta en funció de la posició del punter sobre la linia de temps
  function markerFunction(id){
    marker[id].openPopup();    
  }

  //afegir espai per la informació lateral tipus llegenda
  var superposat = L.control({position: 'topright'}); 
  superposat.onAdd = function (map2) { 
    map2.legend = this;
    var div = L.DomUtil.create('div', 'laSuperposicio'); 
    return div;
  }; 
  superposat.addTo(map2); 

  var numColDataIni=-1;
  var numColDataFin=-1;

  for (c=0;c<row_sub[0].length;c++) {
    if (row_sub[1][c].toLowerCase().indexOf("dataini")>-1) {
      var numColDataIni=c;
    }   
    if (row_sub[1][c].toLowerCase().indexOf("datafin")>-1) {
      var numColDataFin=c;
    }    
    if (row_sub[1][c].toLowerCase().indexOf("titol")>-1) {
      var numColTitol=c;
    }       
  }


  if (numColDataIni==-1 || numColDataFin==-1){
    $('#divTimeLine2').html("<div style='width:75%;border: 2px solid; background-color:#eaeaea;  box-shadow: 5px 10px #888888; display:block; margin: 0 auto'><p style='font-size:2rem; color:red; padding:10px;text-align:center'>No es pot representar cap linia de temps perquè no s'han trobat les columnes etiquetades amb els noms de dataIni i/o dataFin a la segona fila.</p></div>");

  } else {
    google.charts.load('current', {'packages':['timeline']});
    google.charts.setOnLoadCallback(drawChart);
    function drawChart() {
      var container = document.getElementById('divTimeLine2');
      var chart = new google.visualization.Timeline(container);
      var dataTable = new google.visualization.DataTable();

      dataTable.addColumn({ type: 'string', id: 'Position' });
      dataTable.addColumn({ type: 'string', id: 'Esdeveniment' });
      dataTable.addColumn({ type: 'date', id: 'Start' });
      dataTable.addColumn({ type: 'date', id: 'End' });

      var dades=[];
      for (i=3;i<row_sub.length;i++){
        etqTimeLine=row_sub[i][numColTitol];
        dataIni=formatDate(row_sub[i][numColDataIni]);              
        dataFin=formatDate(row_sub[i][numColDataFin]);              
        dades[i-3] =["1",etqTimeLine,dataIni,dataFin];
        //colors[i-3]='#cbb6'+i*10;
      }
      dataTable.addRows(dades)
      
      //*
      var options = {
        //colors: colors
        timeline: { showRowLabels: false },
        avoidOverlappingGridLines: false,
        tooltip: {isHtml: true},
        tooltip: { trigger: 'selection' }
      };    


      chart.draw(dataTable, options);
      //chart.draw(dataTable);    

      //per determinar quin és le pèriode de la linia del temps sobre la que esta el punter
      google.visualization.events.addListener(chart, 'onmouseover', function(e) {
        idMarkerSel=e["row"];
      });

      //per cridar a la targeta del mapa del peridoe clicat
      google.visualization.events.addListener(chart, 'select', function(e) {
        markerFunction(idMarkerSel);
      });

    }

  /*
    function myHandler(e){
      console.log(e);
        if(e.row != null){
            $(".google-visualization-tooltip").html(dataTable.getValue(e.row,4)).css({width:"auto",height:"auto"});
        }        
    }
  //*/  

  }

  $(".laSuperposicio").attr('id', 'Superposicio');           
  $("#Superposicio").css('heigth','580px');   
  $("#Superposicio").css('padding','0px 15px');       
  $("#Superposicio").css('overflow-y','scroll');       
  $("#Superposicio").css('box-shadow','-5px 0px rgb(0,0,0,0.2');
  $("#Superposicio").html(historia); 


  $("#msgTitol").html(titolFinestra);
  $('#historyMap').modal('show'); 
  $('#imgtemp').css('visibility','hidden');  

}
//Final historyMap





//Inici timeLine
function obreTimeLine(pestanya,nomColCerca,valCerca){
  //$('*').css('cursor','wait');
  $('#imgtemp').css('display','block');
  $('#imgtemp').css("visibility","visible");  
  //valCerca=valCerca.replace(new RegExp("′", 'g'),"'"); 
  var id=$("#idFullCalcul").val();
  var colconfig=$("#colconfig").val();      
  var fltr=$("#fltr").val();   
  //google.script.run.withSuccessHandler(onTimeLine).recollidaDadesSub(pestanya,nomColCerca,valCerca,id,colconfig);
  var valors=[pestanya,nomColCerca,valCerca,id,colconfig];
  carregaDades('recollidaDadesSub',valors);  
  
}


function onTimeLine(row_sub){
  for (c=0;c<row_sub[0].length;c++) {
    if (row_sub[1][c].toLowerCase().indexOf("dataini")>-1) {
      var numColDataIni=c;
    }   
    if (row_sub[1][c].toLowerCase().indexOf("datafin")>-1) {
      var numColDataFin=c;
    }    
    if (row_sub[1][c].toLowerCase().indexOf("titol")>-1) {
      var numColTitol=c;
    }       
  }
  //console.log(row_sub);
  var mpas=false;
  var historia='';       

  var titolFinestra="<h3>Línia del temps"+row_sub[3][2]+"</h3>";  
  var coord="[";
  for (i=3;i<row_sub.length;i++){
    coord +="["+row_sub[i][7]+","+row_sub[i][8]+"],";
    if (mpas==false){
      mpas=true;
      historia +="<h3>"+row_sub[i][2]+"</h3>";
      historia +="<img src='"+row_sub[i][9]+"' style='height:300px; box-shadow:10px 15px;'>"; 
    }
    historia +="<div style='heigth:580px;padding; 0px 15px; overflow-y: scroll'>"+row_sub[i][6]+"</div>";   
  };


  google.charts.load('current', {'packages':['timeline']});
  google.charts.setOnLoadCallback(drawChart);
  function drawChart() {
     var container = document.getElementById('divTimeLine');
     var chart = new google.visualization.Timeline(container);
     var dataTable = new google.visualization.DataTable();
     dataTable.addColumn({ type: 'string', id: 'Position' });
     dataTable.addColumn({ type: 'string', id: 'Esdeveniment' });
     dataTable.addColumn({ type: 'date', id: 'Start' });
     dataTable.addColumn({ type: 'date', id: 'End' });
     var dades=[];
     for (i=3;i<row_sub.length;i++){
       dataIni=formatDate(row_sub[i][numColDataIni]);              
       dataFin=formatDate(row_sub[i][numColDataFin]);              
       dades[i-3] =["dades",row_sub[i][numColTitol],dataIni, dataFin];
     }
     dataTable.addRows(dades)
     chart.draw(dataTable);
  }

    //*
    $("#msgTitolTimeline").html(titolFinestra);
    $('#timeLine').modal('show'); 
    $('#imgtemp').css('visibility','hidden');  

    /*/
    $("#timeLine").draggable({
      handle: ".modal-header"
    });
    //*/
}
//fin del timeLine




function hexToRgb(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}


function addslashes(str) {
  str=str.replace(/[']+/g, '&apos;');
  str=str.replace(/\\/g,'\\\\');
  str=str.replace(/\'/g,'\\\'');
  str=str.replace(/\"/g,'\\"');
  str=str.replace(/\0/g,'\\0');
  str=str.replace("\n","\\n");
  return str;
}
  

function getGeoLocation(direccio,i){
    //alert (direccio);
    geocoder = new google.maps.Geocoder();
    geocoder.geocode( { 'address': direccio}, function(results, status) {
      lat[i] = results[0].geometry.location.lat();
      lon[i] = results[0].geometry.location.lng();
      alert("Coordenades de l'adreça: "+direccio+"\n\nlatitud: "+lat[i]+"\nlongitud: "+lon[i]+"\n\n\nIntroduiu les coordenades al full de càlcul per poder representar les dades\n\n");     
      return lat[i];
    });
}


function centrar_avui () { 
  x="document.location.href='#date="+avui+"';";   
  document.location.reload();
  //alert(2);
}

  
function banda_amplada(valor) {
  if (!valor) { 
    z=ban_select.selectedIndex-1;
    bandaTemps=z;
  } else {
    bandaTemps =bandaTemps+valor;
    z= bandaTemps % 11; 
  }
  switch(z){
  case 0:
    tm.changeTimeIntervals([Timeline.DateTime.MILLISECOND,Timeline.DateTime.SECOND]);
    break;  
  case 1:
    tm.changeTimeIntervals([Timeline.DateTime.SECOND,Timeline.DateTime.MINUTE]);
    break;        
  case 2:
    tm.changeTimeIntervals([Timeline.DateTime.MINUTE,Timeline.DateTime.HOUR]);
    break;  
  case 3:
    tm.changeTimeIntervals([Timeline.DateTime.HOUR,Timeline.DateTime.DAY]);
    break;    
  case 4:
    tm.changeTimeIntervals([Timeline.DateTime.DAY,Timeline.DateTime.WEEK]);
    break;      
  case 5:
    tm.changeTimeIntervals([Timeline.DateTime.WEEK,Timeline.DateTime.MONTH]);
    break;
  case 6:
    tm.changeTimeIntervals([Timeline.DateTime.MONTH,Timeline.DateTime.YEAR]);
    break;
  case 7:
    tm.changeTimeIntervals([Timeline.DateTime.YEAR,Timeline.DateTime.DECADE]);
    break;
  case 8:
    tm.changeTimeIntervals([Timeline.DateTime.DECADE,Timeline.DateTime.CENTURY]);
    break;    
  case 9:
    tm.changeTimeIntervals([Timeline.DateTime.CENTURY,Timeline.DateTime.MILLENNIUM]);
    break;
  default:
    if (valor > 0) {
      alert("Ha arribat al límit superior: "+banda[z] );
    } else {
      alert("Ha arribat al límit inferior: "+banda[z+1] );
    }
    bandaTemps -=valor;
  }
}


//modificar l'alçada de la línia del temps
function  global_alçada (valor) {
  var divHeight;
  var obj = document.getElementById('timelinecontainer');
  if (obj.offsetHeight) {timelinecontainer_alçada=obj.offsetHeight;} else if(obj.style.pixelHeight){timelinecontainer_alçada=obj.style.pixelHeight;}
  timelinecontainer_alçada +=valor;
    timelinecontainer.style.height =timelinecontainer_alçada+"px";    
  
  var divHeight;
  var obj = document.getElementById('timeline');
  if (obj.offsetHeight) {timeline_alçada=obj.offsetHeight;} else if(obj.style.pixelHeight){timeline_alçada=obj.style.pixelHeight;}  
  timeline_alçada +=valor;
  timeline.style.height =timeline_alçada+"px";
  
  
  var divTop;
  var obj = document.getElementById('mapa_mes_alçada');
  if (obj.offsetTop) {obj_top=obj.offsetTop;} else if(obj.style.pixelTop){obj_top=obj.style.pixelTop;}  
  obj_top +=valor;
  mapa_mes_alçada.style.top =obj_top+"px";

  
  var divTop;
  var obj = document.getElementById('mapa_menys_alçada');
  if (obj.offsetTop) {obj_top=obj.offsetTop;} else if(obj.style.pixelTop){obj_top=obj.style.pixelTop;}  
  obj_top +=valor;
  mapa_menys_alçada.style.top =obj_top+"px";

  banda_amplada(0);
}


//modificar l'alçada del mapa
function  mapa_alçada (valor) {
  var divHeight;
  var obj = document.getElementById('map');
  if (obj.offsetHeight) {map_alçada=obj.offsetHeight;} else if(obj.style.pixelHeight){map_alçada=obj.style.pixelHeight;}
  map_alçada +=valor;
    map.style.height =map_alçada+"px";    
  
  var divHeight;
  var obj = document.getElementById('mapcontainer');
  if (obj.offsetHeight) {mapcontainer_alçada=obj.offsetHeight;} else if(obj.style.pixelHeight){mapcontainer_alçada=obj.style.pixelHeight;}  
  mapcontainer_alçada +=valor;
  mapcontainer.style.height =mapcontainer_alçada+"px";
  
}


function creaTimeMap(finalArray){
    inici=[]; fin=[]; titol=[]; titol_curs=[]; text=[]; bloc=[]; lat=[]; lon=[]; targetes=[];
  for(i=3; i<finalArray.length; i++) {
    inici[i-3] = finalArray[i][numColDataIni];
    fin[i-3] = finalArray[i][numColDataFin];
    titol[i-3] = finalArray[i][numColTitol];
    titol_curt[i-3] = finalArray[i][numColTitol];               
    text[i-3]= finalArray[i][numColDescripcio];
    bloc[i-3]= finalArray[i][numColBloc];
    lat[i-3] = finalArray[i][numColLatitud];
    lon[i-3] = finalArray[i][numColLongitud];
    
    targetes[i-3]="<div class=finestra>";
        /*
    if (media[i]) {
      targetes[i] +="<div class=esq><img src="+media[i]+" height=125 width=125></div>";
    }
    targetes[i] +="<div class=dret><p style=font-weight:bold;font-size:0.9em>"+titol[i]+"</p>";
    if (inici[i]==fin[i]) {
      targetes[i] +="<p style=font-size:0.85em>Data: "+inici[i]+"</p>";
    } else {
      targetes[i] +="<p style=font-size:0.85em>Del "+inici[i]+" al "+fin[i]+"</p>";
    }
    targetes[i] +="<p style=font-size:0.85em>adreça: "+adreça[i]+" ("+poblacio[i]+")</p>";
    if (enllaç[i]) {
      targetes[i] +="<p style=font-size:0.85em><a href="+enllaç[i]+" target=_blank>Informació addicional</a></p></div>";
    }
    targetes[i-3] +="</div>";
        //*/
        
    poblacio[i] ="Barcelona";
    adreça[i]= "";        

    media[i]= "Media";
    enllaç[i]= "";        
        
        targetes[i-3] ="Prova";     
        //console.log(i+"---"+lat[i-3])
  }


  var str="";
    str +="Finestra de temps: "
    str +="<select id='ban_select' onchange='banda_amplada();'>";
      for (i=0; i< banda.length; i++) {   
        if (banda[i] == finestra_temporal) {
          str +="<option value='"+i+"' selected >"+banda[i]+"</option>";
        } else {
          str +="<option value='"+i+"'>"+banda[i]+"</option>";
        }
      }
    str +="</select>";


  var pantalla ="<div id='global_menys_alçada'><input type='image' src='https://drive.google.com/uc?id=1l7EGqYTHx4qJW9QXzAUQbcPFcRCqwgHB' width='15' height='15' onclick='global_alçada(-5);'></div>";
    pantalla +="<div id='global_mes_alçada'><input type='image' src='https://drive.google.com/uc?id=1Vef6fsY_XlO-O1m5pyRoBiLR2Cch6mbs' width='15' height='15' onclick='global_alçada(+5);'></div>";
    pantalla +="<div id='mapa_menys_alçada'><input type='image' src='https://drive.google.com/uc?id=1l7EGqYTHx4qJW9QXzAUQbcPFcRCqwgHB' width='15' height='15' onclick='mapa_alçada(-5);'></div>";   
    pantalla +="<div id='mapa_mes_alçada'><input type='image' src='https://drive.google.com/uc?id=1Vef6fsY_XlO-O1m5pyRoBiLR2Cch6mbs.png' width='15' height='15' onclick='mapa_alçada(+5);'></div>";       
    pantalla +="<div id='timemap' style= 'height:550px' >";         
    pantalla +="<div id='timelinecontainer'>";
    pantalla +="<div id=''>"+str+"</div>";        
    //pantalla +="<div id='timeline_amplada_text' style='font-size: 10px'>Finestra de temps</div>";
    //pantalla +="<div id='timeline_amplada'><input Type='image' src='https://edumet.cat/areatac/cartografia/images/menys.png' width='15' height='15' onclick='banda_amplada(-1);'>";    
    //pantalla +="<input  Type='image' src='https://edumet.cat/areatac/cartografia/images/mes.png' width='15' height='15' onclick='banda_amplada(+1);'></div>";  
    pantalla +="<div id='timeline'>";
    pantalla +="</div></div>";
    pantalla +="<div id='mapcontainer'><div id='map_2'></div></div></div></div>"; 
  $("#divPresTimeMap").html(pantalla);
  

  $(function() {
    var cadena="[";
      pas = false;
      options=" theme: 'orange'";
      str = "";
      c=0;
      j=0;
      //for(i=0; i<lat.length; i++) { 
      for(i=0; i<5; i++) {       
        if (lat[i]) {
          //per determinar si és o no l'inici de la cadena
          if (pas == true) {
            cadena +=',';
          }
          pas=true;
          //determinar el color de cada bloc
          if (bloc[i]) {
            for (k=0; k< bloc_nom.length ; k++) {       
              if (bloc[i] == bloc_nom[k]) {
                color_objecte=bloc_color[k];
              }
            }
          }
          color_objecte=bloc_color[1];
          // per determinar si ha de representar una línia o un punt
          if(inici[i] == fin[i]) {
            //punt
            //dates=new Date(inici[i])+'",'
            dates=formatDate(inici[i])+'",'                        
          } else {
            //linia
            //dates=new Date(inici[i]).format('YYYY-MM-DD')+'", "end" : "'+new Date(fin[i]).format('YYYY-MM-DD')+'",'            
            dates=formatDate(inici[i])+'", "end" : "'+formatDate(fin[i])+'",'                        
            formatDate(inici[i])
            /*
            dataIni=new Date(inici[i])
            dataIni=dataIni.format('YYYY-MM-DD')
            dataFin=new Date(fin[i])
            dataFin=dataFin.format('YYYY-MM-DD')                                                
            dates=dataIni+'", "end" : "'+dataFin+'",'
            //*/
            
          }
      
          cadena += '{ "start" : "'+dates+
            '"point" : {"lat" : '+lat[i]+',"lon" : '+lon[i]+'},'+
            '"title" : "'+addslashes(titol_curt[i])+'",'+
            '"options" : { "infoHtml": "'+addslashes(targetes[i])+'", "theme": "'+color_objecte+'", "description": "tags1: ['+bloc[i]+']", "tags": ["'+bloc[i]+'"] } }'
   
        } else {
          //S'ha d'obtenir de google geocoder
          //direccio=adreça[i]+" "+poblacio[i]+": latitud="+lat[i]+" ,longitud="+lon[i];
          //alert(direccio+"\n\nIntroduiu al full de càlcul les dades que surtiran més endavant relacionades amb aquesta adreça");    
        }
      }
    cadena +=']';

    //console.log(cadena);
    alert(cadena)
    
    var tm = TimeMap.init({
      mapId: 'map_2',
      timelineId: 'timeline',
      //*
      options: {
        eventIconPath: 'https://edumet.cat/areatac/cartografia/libimages/'
      },
      datasets: [{
        id: 'artists',
        title: titol_pagina,
        theme: mapaColor,       
        type: tipus,
        options: {
          items: JSON.parse(cadena) 
          //items: cadena           
        }
      }],
      //bandIntervals: bandIntervals
      bandIntervals: [Timeline.DateTime.DECADE,Timeline.DateTime.CENTURY]
    });
    
    //alert(2)
    /*
    var gmap = tm.getNativeMap();
    gmap.mapTypes.set("white", styledMapType);
    gmap.setMapTypeId("white");
    */  
  
//*
    // filter function for tags
    var hasSelectedTag = function(item) {
      //alert("pas1: "+item);
      // if no tag was selected, everything passes
      return !window.selectedTag || (
        // item has tags?
        item.opts.tags && 
        // tag found? (note - will work in IE; Timemap extends the Array prototype if necessary)
        item.opts.tags.indexOf(window.selectedTag) >= 0
      );
    };
  
    // add our new function to the map and timeline filters
    tm.addFilter("map_2", hasSelectedTag); // hide map markers on fail
    tm.addFilter("timeline", hasSelectedTag); // hide timeline events on fail
  
    
    // onChange gestor del menu de filtres de bloc
    $('#tag_select').change(function() {
      window.selectedTag = $(this).val();
      tm.filter('map_2');
      tm.filter('timeline');
    });
//*/
  });
}


function creaTimeLine(finalArray){
  google.charts.load('current', {'packages':['timeline']});
  google.charts.setOnLoadCallback(drawChart);
  function drawChart() {
     var container = document.getElementById('divPresTimeLine');
     var chart = new google.visualization.Timeline(container);
     var dataTable = new google.visualization.DataTable();

     dataTable.addColumn({ type: 'string', id: 'President' });
     dataTable.addColumn({ type: 'date', id: 'Start' });
     dataTable.addColumn({ type: 'date', id: 'End' });
     for (i=3;i<finalArray.length;i++){
       dataIni=formatDate(finalArray[i][numColDataIni]);              
       dataFin=formatDate(finalArray[i][numColDataFin]);              
       //console.log(finalArray[i][numColTitol]+"--"+dataIni+"--"+dataFin)
       dataTable.addRow([finalArray[i][numColTitol],dataIni, dataFin])
     }
     chart.draw(dataTable);
  }
  $('#divPresTimeLine').css("height","600px");  
}


function formatDate(date) {
    year=date.substr(date.length -4);
    month=date.substr(3,2);    
    day=date.substr(0,2);        
    //var data=new Date(year, month, day);    
    //data.format('YYYY-MM-DD');
    return new Date(year, month, day);
}

function gm_authFailure() {
  missatgeError('El mapa no es pot mostrar perquè la clau API del full de configuració no és correcta. Si us plau, substituiu-la per una de vàlida');
};

function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

/*
 * Natural Sort algorithm for Javascript - Version 0.7 - Released under MIT license
 * Author: Jim Palmer (based on chunking idea from Dave Koelle)
 */
 function naturalSort (a, b) {
    var re = /(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,
        sre = /(^[ ]*|[ ]*$)/g,
        dre = /(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,
        hre = /^0x[0-9a-f]+$/i,
        ore = /^0/,
        i = function(s) { return naturalSort.insensitive && (''+s).toLowerCase() || ''+s },
        // convert all to strings strip whitespace
        x = i(a).replace(sre, '') || '',
        y = i(b).replace(sre, '') || '',
        // chunk/tokenize
        xN = x.replace(re, '\0$1\0').replace(/\0$/,'').replace(/^\0/,'').split('\0'),
        yN = y.replace(re, '\0$1\0').replace(/\0$/,'').replace(/^\0/,'').split('\0'),
        // numeric, hex or date detection
        xD = parseInt(x.match(hre)) || (xN.length != 1 && x.match(dre) && Date.parse(x)),
        yD = parseInt(y.match(hre)) || xD && y.match(dre) && Date.parse(y) || null,
        oFxNcL, oFyNcL;
    // first try and sort Hex codes or Dates
    if (yD)
        if ( xD < yD ) return -1;
        else if ( xD > yD ) return 1;
    // natural sorting through split numeric strings and default strings
    for(var cLoc=0, numS=Math.max(xN.length, yN.length); cLoc < numS; cLoc++) {
        // find floats not starting with '0', string or 0 if not defined (Clint Priest)
        oFxNcL = !(xN[cLoc] || '').match(ore) && parseFloat(xN[cLoc]) || xN[cLoc] || 0;
        oFyNcL = !(yN[cLoc] || '').match(ore) && parseFloat(yN[cLoc]) || yN[cLoc] || 0;
        // handle numeric vs string comparison - number < string - (Kyle Adams)
        if (isNaN(oFxNcL) !== isNaN(oFyNcL)) { return (isNaN(oFxNcL)) ? 1 : -1; }
        // rely on string comparison if different types - i.e. '02' < 2 != '02' < '2'
        else if (typeof oFxNcL !== typeof oFyNcL) {
            oFxNcL += '';
            oFyNcL += '';
        }
        if (oFxNcL < oFyNcL) return -1;
        if (oFxNcL > oFyNcL) return 1;
    }
    return 0;
}

</script>

<!--div on es carregaran els estils -->
<style id="divEstil">
</style>

<!--div on es carregaran els scripts -->
<div id="divScript">
</div>

<div id="divDiv">
</div>
<script> inicia(); </script>
</html>

